<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>إدارة المندوبين</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 900px;
        margin: 20px auto;
        direction: rtl;
        background: #f9f9f9;
        color: #333;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 0 10px #ccc;
      }
      th,
      td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: center;
      }
      th {
        background-color: #34495e;
        color: white;
      }
      input,
      select {
        width: 90%;
        padding: 5px;
        box-sizing: border-box;
        font-size: 1rem;
      }
      button {
        cursor: pointer;
        padding: 5px 10px;
        font-size: 1rem;
      }
      .alert {
        margin: 10px 0;
        padding: 10px;
        color: white;
        display: none;
        border-radius: 4px;
      }
      .alert.success {
        background-color: #28a745;
      }
      .alert.error {
        background-color: #dc3545;
      }
    </style>
  </head>
  <body>
    <h1>إدارة المندوبين</h1>

    <table id="agentsTable">
      <thead>
        <tr>
          <th>الاسم</th>
          <th>البريد الإلكتروني</th>
          <th>الدور</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody>
        <!-- سيتم تعبئة البيانات هنا -->
      </tbody>
    </table>

    <div id="editAgentsAlert" class="alert"></div>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const supabase = createClient(
        "https://vyhtsdqccyvygelekzey.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5aHRzZHFjY3l2eWdlbGVremV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTQwOTMsImV4cCI6MjA2NTMzMDA5M30.bRjHD6OkziXjfavEX-tA-6IFdag7KoFBqLRgNLqwcdg"
      );

      // تحميل بيانات المندوبين
      async function loadAgentsForEdit() {
        const tbody = document.querySelector("#agentsTable tbody");
        tbody.innerHTML = "";
        const { data: agents, error } = await supabase
          .from("agents")
          .select("*");
        const alertBox = document.getElementById("editAgentsAlert");
        alertBox.style.display = "none";

        if (error) {
          alertBox.textContent = "❌ خطأ في تحميل المندوبين: " + error.message;
          alertBox.className = "alert error";
          alertBox.style.display = "block";
          return;
        }

        agents.forEach((agent) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td><input type="text" value="${agent.name}" data-id="${
            agent.id
          }" data-field="name" /></td>
          <td><input type="email" value="${agent.email}" data-id="${
            agent.id
          }" data-field="email" /></td>
          <td>
            <select data-id="${agent.id}" data-field="role">
              <option value="agent" ${
                agent.role === "agent" ? "selected" : ""
              }>مندوب</option>
              <option value="admin" ${
                agent.role === "admin" ? "selected" : ""
              }>أدمن</option>
            </select>
          </td>
          <td>
            <button class="saveAgentBtn" data-id="${agent.id}">💾 حفظ</button>
            <button class="deleteAgentBtn" data-id="${agent.id}">🗑️ حذف</button>
          </td>
        `;
          tbody.appendChild(tr);
        });
      }

      // التعامل مع حفظ التعديلات أو الحذف
      document
        .querySelector("#agentsTable")
        .addEventListener("click", async (e) => {
          const agentId = e.target.getAttribute("data-id");
          const alertBox = document.getElementById("editAgentsAlert");
          alertBox.style.display = "none";

          // حفظ التعديلات
          if (e.target.classList.contains("saveAgentBtn")) {
            const row = e.target.closest("tr");
            const inputs = row.querySelectorAll("[data-field]");
            const updatedData = {};
            inputs.forEach((input) => {
              const field = input.getAttribute("data-field");
              updatedData[field] = input.value.trim();
            });

            if (!updatedData.name || !updatedData.email || !updatedData.role) {
              alertBox.textContent = "❌ يرجى تعبئة جميع الحقول";
              alertBox.className = "alert error";
              alertBox.style.display = "block";
              return;
            }

            const { error } = await supabase
              .from("agents")
              .update(updatedData)
              .eq("id", agentId);
            if (error) {
              alertBox.textContent = "❌ حدث خطأ أثناء الحفظ: " + error.message;
              alertBox.className = "alert error";
            } else {
              alertBox.textContent = "✅ تم حفظ التعديلات بنجاح";
              alertBox.className = "alert success";
            }
            alertBox.style.display = "block";
            setTimeout(() => (alertBox.style.display = "none"), 3000);
            await loadAgentsForEdit();
          }

          // حذف المندوب
          if (e.target.classList.contains("deleteAgentBtn")) {
            if (confirm("⚠️ هل تريد حذف هذا المندوب؟")) {
              const { error } = await supabase
                .from("agents")
                .delete()
                .eq("id", agentId);
              if (error) {
                alertBox.textContent =
                  "❌ حدث خطأ أثناء الحذف: " + error.message;
                alertBox.className = "alert error";
              } else {
                alertBox.textContent = "✅ تم حذف المندوب بنجاح";
                alertBox.className = "alert success";
              }
              alertBox.style.display = "block";
              setTimeout(() => (alertBox.style.display = "none"), 3000);
              await loadAgentsForEdit();
            }
          }
        });

      // تحميل البيانات عند فتح الصفحة
      window.addEventListener("load", loadAgentsForEdit);
    </script>
  </body>
</html>
