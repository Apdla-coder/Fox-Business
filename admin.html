<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 900px;
        margin: 20px auto;
        direction: rtl;
        background: #f9f9f9;
        color: #333;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 0 10px #ccc;
      }
      th,
      td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: center;
      }
      th {
        background-color: #34495e;
        color: white;
      }
      input,
      select {
        width: 90%;
        padding: 5px;
        box-sizing: border-box;
        font-size: 1rem;
      }
      button {
        cursor: pointer;
        padding: 5px 10px;
        font-size: 1rem;
      }
      .alert {
        margin: 10px 0;
        padding: 10px;
        color: white;
        display: none;
        border-radius: 4px;
      }
      .alert.success {
        background-color: #28a745;
      }
      .alert.error {
        background-color: #dc3545;
      }
    </style>
  </head>
  <body>
    <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</h1>

    <table id="agentsTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
          <th>Ø§Ù„Ø¯ÙˆØ±</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody>
        <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§ -->
      </tbody>
    </table>

    <div id="editAgentsAlert" class="alert"></div>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const supabase = createClient(
        "https://vyhtsdqccyvygelekzey.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5aHRzZHFjY3l2eWdlbGVremV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTQwOTMsImV4cCI6MjA2NTMzMDA5M30.bRjHD6OkziXjfavEX-tA-6IFdag7KoFBqLRgNLqwcdg"
      );

      // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†
      async function loadAgentsForEdit() {
        const tbody = document.querySelector("#agentsTable tbody");
        tbody.innerHTML = "";
        const { data: agents, error } = await supabase
          .from("agents")
          .select("*");
        const alertBox = document.getElementById("editAgentsAlert");
        alertBox.style.display = "none";

        if (error) {
          alertBox.textContent = "âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†: " + error.message;
          alertBox.className = "alert error";
          alertBox.style.display = "block";
          return;
        }

        agents.forEach((agent) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td><input type="text" value="${agent.name}" data-id="${
            agent.id
          }" data-field="name" /></td>
          <td><input type="email" value="${agent.email}" data-id="${
            agent.id
          }" data-field="email" /></td>
          <td>
            <select data-id="${agent.id}" data-field="role">
              <option value="agent" ${
                agent.role === "agent" ? "selected" : ""
              }>Ù…Ù†Ø¯ÙˆØ¨</option>
              <option value="admin" ${
                agent.role === "admin" ? "selected" : ""
              }>Ø£Ø¯Ù…Ù†</option>
            </select>
          </td>
          <td>
            <button class="saveAgentBtn" data-id="${agent.id}">ğŸ’¾ Ø­ÙØ¸</button>
            <button class="deleteAgentBtn" data-id="${agent.id}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </td>
        `;
          tbody.appendChild(tr);
        });
      }

      // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø£Ùˆ Ø§Ù„Ø­Ø°Ù
      document
        .querySelector("#agentsTable")
        .addEventListener("click", async (e) => {
          const agentId = e.target.getAttribute("data-id");
          const alertBox = document.getElementById("editAgentsAlert");
          alertBox.style.display = "none";

          // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
          if (e.target.classList.contains("saveAgentBtn")) {
            const row = e.target.closest("tr");
            const inputs = row.querySelectorAll("[data-field]");
            const updatedData = {};
            inputs.forEach((input) => {
              const field = input.getAttribute("data-field");
              updatedData[field] = input.value.trim();
            });

            if (!updatedData.name || !updatedData.email || !updatedData.role) {
              alertBox.textContent = "âŒ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„";
              alertBox.className = "alert error";
              alertBox.style.display = "block";
              return;
            }

            const { error } = await supabase
              .from("agents")
              .update(updatedData)
              .eq("id", agentId);
            if (error) {
              alertBox.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: " + error.message;
              alertBox.className = "alert error";
            } else {
              alertBox.textContent = "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­";
              alertBox.className = "alert success";
            }
            alertBox.style.display = "block";
            setTimeout(() => (alertBox.style.display = "none"), 3000);
            await loadAgentsForEdit();
          }

          // Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨
          if (e.target.classList.contains("deleteAgentBtn")) {
            if (confirm("âš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ØŸ")) {
              const { error } = await supabase
                .from("agents")
                .delete()
                .eq("id", agentId);
              if (error) {
                alertBox.textContent =
                  "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: " + error.message;
                alertBox.className = "alert error";
              } else {
                alertBox.textContent = "âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø¨Ù†Ø¬Ø§Ø­";
                alertBox.className = "alert success";
              }
              alertBox.style.display = "block";
              setTimeout(() => (alertBox.style.display = "none"), 3000);
              await loadAgentsForEdit();
            }
          }
        });

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
      window.addEventListener("load", loadAgentsForEdit);
    </script>
  </body>
</html>
