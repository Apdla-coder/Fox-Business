<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</title>
    <style>
      /* =========== Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ =========== */
      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #2c3e50, #4ca1af);
        color: #f5f5f5;
        padding: 20px;
        max-width: 800px;
        margin: auto;
        line-height: 1.5;
      }

      /* =========== Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† =========== */
      h2,
      h3 {
        text-align: center;
        font-weight: bold;
        margin: 15px 0;
      }
      h2 {
        font-size: 1.3rem;
        color: #fffae3;
      }
      h3 {
        font-size: 1.1rem;
        color: #fffae3;
      }
      a {
        color: orange;
        text-decoration: none;
        font-weight: bold;
      }
      a:hover {
        text-decoration: underline;
      }

      /* =========== Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© =========== */
      #addAgentContainer,
      .form-container {
        margin: 25px auto;
        padding: 20px;
        background-color: rgba(255, 255, 255, 0.08);
        border-radius: 6px;
      }

      /* =========== Ø§Ù„ÙÙˆØ±Ù… Ø¹Ù„Ù‰ Ø³Ø·Ø±ÙŠÙ† =========== */
      .form-row {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 20px;
      }
      .form-group {
        flex: 1 1 48%;
        display: flex;
        flex-direction: column;
        margin-bottom: 15px;
      }
      label {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 5px;
      }
      select,
      input,
      button {
        padding: 8px 12px;
        font-size: 0.9rem;
        border-radius: 4px;
        border: none;
        outline: none;
      }
      select,
      input {
        width: 80%; /* Ù…Ø±ÙŠØ­ Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨ */
        margin-bottom: 20px;
      }
      select:focus,
      input:focus {
        border: 1px solid #fffae3;
      }

      /* =========== Ø§Ù„Ø¬Ø¯ÙˆÙ„ =========== */
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        margin: 20px 0;
      }
      table thead {
        background-color: rgba(255, 255, 255, 0.15);
      }
      table th,
      table td {
        padding: 8px;
        text-align: center;
        border-bottom: 1px solid #888;
      }
      table tr:hover {
        background-color: rgba(255, 255, 255, 0.07);
      }

      /* =========== Ø§Ù„Ø£Ø²Ø±Ø§Ø± =========== */
      button {
        cursor: pointer;
        font-weight: bold;
        background-color: #fffae3;
        color: #2c3e50;
        margin: 5px 0;
      }
      button:hover {
        background-color: #ffe97f;
      }

      /* =========== Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„Ø­Ø§Ù„Ø© =========== */
      #uploadLoader {
        font-size: 14px;
        color: #ffe97f;
      }
      #addAgentAlert,
      #uploadStatus,
      #clearStatus {
        margin: 10px 0;
        padding: 8px;
        font-size: 13px;
        font-weight: bold;
        border-radius: 4px;
      }
      #addAgentAlert {
        display: none;
      }

      /* =========== Ù…ÙˆØ¨Ø§ÙŠÙ„ =========== */
      @media (max-width: 768px) {
        .form-group {
          flex: 1 1 100%; /* Ø¹Ù†ØµØ± ÙƒØ§Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø·Ø± Ø¹Ù„Ù‰ Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        }
        select,
        input {
          width: 100%; /* Ø¹Ù„Ù‰ Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙŠØªÙ…Ø¯Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„ */
        }
      }
    </style>
  </head>
  <body>
    <!-- =========== Ø§Ù„Ù‡ÙŠØ¯Ø± =========== -->
    <header
      style="
        background: linear-gradient(45deg, #2c3e50, #4ca1af);
        padding: 15px 30px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: #fff;
        border-bottom-left-radius: 10px;
        border-bottom-right-radius: 10px;
      "
    >
      <div style="display: flex; align-items: center">
        <a href="./index.html"
          ><img
            src="./Orange_logo.svg.png"
            alt="Logo"
            style="height: 40px; margin-left: 10px; border-radius: 5px"
        /></a>
        <h2 style="margin: 0">ÙÙˆÙƒØ³ Ø¨ÙŠØ²Ù†ÙŠØ³</h2>
      </div>
      <div style="font-size: 16px">
        <a href="./dashboard.html"><h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â¬…</h2></a>
      </div>
    </header>

    <!-- =========== Ø±ÙØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ =========== -->
    <h2>Ø±ÙØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
    <div class="form-container">
      <label for="agentSelect">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</label>
      <select id="agentSelect">
        <option value="">-- Ø§Ø®ØªØ± --</option>
      </select>
      <label for="excelFile">Ù…Ù„Ù Excel:</label>
      <input type="file" id="excelFile" accept=".xls,.xlsx" />
      <button id="excelUploadButton">ğŸ“¤ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      <div id="uploadStatus"></div>
      <div id="uploadLoader" style="display: none">â³ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </div>

    <!-- =========== Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =========== -->
    <h2>Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
    <button id="clearButton">ğŸ§¨ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    <div id="clearStatus"></div>

    <!-- =========== ÙÙˆØ±Ù… Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨ =========== -->
    <div id="addAgentContainer">
      <h3>â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨</h3>
      <div id="addAgentAlert"></div>
      <input id="newAgentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨" />
      <input id="newAgentEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
      <input id="newAgentPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
      <select id="newAgentRole">
        <option value="agent">Ù…Ù†Ø¯ÙˆØ¨</option>
        <option value="admin">Ø£Ø¯Ù…Ù†</option>
      </select>
      <button id="addAgentButton">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨</button>
    </div>

    <!-- =========== Ø§Ù„ÙÙˆØªØ± =========== -->
    <footer
      style="
        background: #2c3e50;
        color: #fff;
        text-align: center;
        padding: 15px;
        font-size: 14px;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        margin-top: 40px;
      "
    >
      <div>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; ÙÙˆÙƒØ³ Ø¨ÙŠØ²Ù†ÙŠØ³</div>
      <div>Ù…Ø·ÙˆØ± Ø§Ù„Ù†Ø¸Ø§Ù…: Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù‡Ø§Ù†ÙŠ</div>
      <div>Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: 01212555345</div>
    </footer>

    <!-- =========== Ø§Ù„Ø¬Ø§ÙØ§ Ø³ÙƒØ±Ø¨Øª =========== -->
    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
      import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm";

      const supabase = createClient(
        "https://vyhtsdqccyvygelekzey.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5aHRzZHFjY3l2eWdlbGVremV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTQwOTMsImV4cCI6MjA2NTMzMDA5M30.bRjHD6OkziXjfavEX-tA-6IFdag7KoFBqLRgNLqwcdg"
      );

      window.onload = async () => {
        await loadAgentsOptions();
        attachEventListeners();
      };

      function attachEventListeners() {
        document
          .getElementById("excelUploadButton")
          ?.addEventListener("click", uploadExcel);
        document
          .getElementById("clearButton")
          ?.addEventListener("click", clearAllData);
        document
          .getElementById("addAgentButton")
          ?.addEventListener("click", addAgent);
      }

      async function loadAgentsOptions() {
        const select = document.getElementById("agentSelect");
        if (!select) return;

        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ù†Ø¯ÙˆØ¨ --</option>';
        const { data: agents, error } = await supabase
          .from("agents")
          .select("*");
        if (error) {
          alert("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†");
          return;
        }
        agents?.forEach((agent) => {
          const option = document.createElement("option");
          option.value = agent.id;
          option.textContent = agent.name;
          select.appendChild(option);
        });
      }

      async function uploadExcel() {
        const fileInput = document.getElementById("excelFile");
        const loader = document.getElementById("uploadLoader");
        const agent_id = document.getElementById("agentSelect").value;

        if (!agent_id) return setStatus("âš ï¸ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø£ÙˆÙ„Ø§Ù‹.", "red");
        if (!fileInput.files.length)
          return setStatus("ğŸ“„ Ø§Ø®ØªØ± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹.", "red");

        try {
          loader.style.display = "block";
          setStatus("", "");
          const file = fileInput.files[0];
          const data = new Uint8Array(await file.arrayBuffer());
          const workbook = XLSX.read(data, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet);

          if (!rows.length)
            return setStatus("âŒ Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ØºÙŠØ± ØµØ­ÙŠØ­.", "red");

          const currentMonth = new Date().toISOString().slice(0, 7);
          const newCustomers = [];
          const updates = [];

          for (const row of rows) {
            const phone = row.phone?.toString().trim();
            const due_amount = Number(row.due_amount) || 0;

            if (!phone || due_amount <= 0) continue;

            const { data: existing } = await supabase
              .from("customers")
              .select("*")
              .eq("phone", phone)
              .eq("agent_id", agent_id)
              .order("created_at", { ascending: false })
              .limit(1)
              .maybeSingle();

            if (existing) {
              if (existing.collection_status === "ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„") {
                newCustomers.push({
                  ...row,
                  agent_id,
                  billing_month: currentMonth,
                  collection_status: "Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„",
                });
              } else {
                updates.push({
                  id: existing.id,
                  due_amount: (existing.due_amount || 0) + due_amount,
                  billing_month: currentMonth,
                });
              }
            } else {
              newCustomers.push({
                ...row,
                agent_id,
                billing_month: currentMonth,
                collection_status: "Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„",
              });
            }
          }

          if (newCustomers.length) {
            const { error: insertError } = await supabase
              .from("customers")
              .insert(newCustomers);
            if (insertError) {
              return setStatus("âŒ ÙØ´Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.", "red");
            }
          }

          for (const u of updates) {
            const { error: updateError } = await supabase
              .from("customers")
              .update({
                due_amount: u.due_amount,
                billing_month: u.billing_month,
              })
              .eq("id", u.id);
            if (updateError) {
              console.error(
                `âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„ ${u.id}:`,
                updateError.message
              );
            }
          }

          setStatus("âœ… ØªÙ… Ø±ÙØ¹ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.", "green");
          fileInput.value = "";
        } catch (err) {
          console.error("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£:", err.message);
          setStatus("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.", "red");
        } finally {
          loader.style.display = "none";
        }
      }

      async function clearAllData() {
        const status = document.getElementById("clearStatus");
        if (!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) return;

        await supabase.from("collections").delete().not("id", "is", null);
        await supabase.from("customers").delete().not("id", "is", null);
        status.innerText = "âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.";
        status.style.color = "green";
      }

      function setStatus(msg, color) {
        const el = document.getElementById("uploadStatus");
        el.innerText = msg;
        el.style.color = color;
      }

      async function addAgent() {
        const name = document.getElementById("newAgentName").value.trim();
        const email = document.getElementById("newAgentEmail").value.trim();
        const password = document
          .getElementById("newAgentPassword")
          .value.trim();
        const role = document.getElementById("newAgentRole").value;

        const alertBox = document.getElementById("addAgentAlert");
        if (!name || !email || !password) {
          alertBox.innerText = "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.";
          alertBox.style.display = "block";
          alertBox.style.backgroundColor = "#f8d7da";
          alertBox.style.color = "#721c24";
          return;
        }

        const { error } = await supabase
          .from("agents")
          .insert([{ name, email, password, role }]);
        if (error) {
          alertBox.innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨.";
          alertBox.style.display = "block";
          alertBox.style.backgroundColor = "#f8d7da";
          alertBox.style.color = "#721c24";
          console.error(error);
        } else {
          alertBox.innerText = "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…";
          alertBox.style.display = "block";
          alertBox.style.backgroundColor = "#d4edda";
          alertBox.style.color = "#155724";
          document.getElementById("newAgentName").value = "";
          document.getElementById("newAgentEmail").value = "";
          document.getElementById("newAgentPassword").value = "";
        }
      }
    </script>
  </body>
</html>
