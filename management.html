<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>رفع البيانات وإدارة المناديب</title>
    <style>
      /* =========== الشكل الأساسي =========== */
      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #2c3e50, #4ca1af);
        color: #f5f5f5;
        padding: 20px;
        max-width: 800px;
        margin: auto;
        line-height: 1.5;
      }

      /* =========== العناوين =========== */
      h2,
      h3 {
        text-align: center;
        font-weight: bold;
        margin: 15px 0;
      }
      h2 {
        font-size: 1.3rem;
        color: #fffae3;
      }
      h3 {
        font-size: 1.1rem;
        color: #fffae3;
      }

      /* =========== اللينكات =========== */
      a {
        color: #fffa90;
        text-decoration: none;
        font-weight: bold;
        transition: color 0.3s, text-decoration 0.3s;
      }
      a:hover {
        text-decoration: underline;
        color: #ffe97f;
      }

      /* =========== الحاويات العامة =========== */
      #addAgentContainer,
      .form-container {
        margin: 25px auto;
        padding: 20px;
        background-color: rgba(255, 255, 255, 0.08);
        border-radius: 6px;
        box-shadow: 0px 4px 15px rgba(255, 255, 255, 0.1);
      }

      /* =========== الفورم على سطرين =========== */
      .form-row {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 20px;
      }
      .form-group {
        flex: 1 1 48%;
        display: flex;
        flex-direction: column;
        margin-bottom: 15px;
      }
      label {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 5px;
        color: #fffae3;
      }
      select,
      input,
      button {
        padding: 9px 12px;
        font-size: 0.95rem;
        border-radius: 4px;
        border: none;
        outline: none;
        transition: box-shadow 0.3s;
      }
      select,
      input {
        width: 80%; /* مريح على الديسكتوب */
        margin-bottom: 20px;
      }
      select:focus,
      input:focus {
        box-shadow: 0px 0px 8px rgba(255, 250, 227, 0.5);
      }

      /* =========== الجدول =========== */
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        margin: 20px 0;
        border-radius: 8px;
        overflow: hidden;
      }
      table thead {
        background-color: rgba(255, 255, 255, 0.15);
      }
      table th,
      table td {
        padding: 8px;
        text-align: center;
        border-bottom: 1px solid #888;
      }
      table tr:hover {
        background-color: rgba(255, 255, 255, 0.07);
      }

      /* =========== الأزرار =========== */
      button {
        cursor: pointer;
        font-weight: bold;
        background-color: #fffae3;
        color: #2c3e50;
        margin: 5px 0;
        padding: 9px 15px;
        border-radius: 5px;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #ffe97f;
      }

      /* =========== الرسائل وحالة التحديث =========== */
      #uploadLoader {
        font-size: 14px;
        color: #ffe97f;
      }
      #addAgentAlert,
      #uploadStatus,
      #clearStatus {
        margin: 10px 0;
        padding: 8px;
        font-size: 13px;
        font-weight: bold;
        border-radius: 4px;
        text-align: center;
      }
      #addAgentAlert {
        display: none;
      }

      /* =========== موبايل =========== */
      @media (max-width: 768px) {
        .form-group {
          flex: 1 1 100%; /* عنصر كامل على السطر على موبايل */
        }
        select,
        input {
          width: 100%; /* مريح على موبايل */
        }
      }
    </style>
  </head>
  <body>
    <!-- =========== الهيدر =========== -->
    <header
      style="
        background: linear-gradient(45deg, #2c3e50, #4ca1af);
        padding: 15px 30px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: #fff;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
        border-bottom-left-radius: 10px;
        border-bottom-right-radius: 10px;
      "
    >
      <div style="display: flex; align-items: center">
        <a href="./index.html"
          ><img
            src="./Orange_logo.svg.png"
            alt="Logo"
            style="height: 50px; margin-left: 15px; border-radius: 8px"
        /></a>
        <h2 style="margin: 0">فوكس بيزنيس</h2>
      </div>
      <div style="font-size: 16px; display: flex; gap: 20px">
        <a href="./management.html"><h2>رفع البيانات وإدارة المناديب ⬅</h2></a>
        <a href="./agents_performance.html"><h2>أداء المناديب ⬅</h2></a>
        <a href="./dashboard.html"><h2>لوحة التحكم ⬅</h2></a>
      </div>
    </header>
    <!-- اختيار مندوب، اختيار القسم، رفع الملف -->
    <!-- <h2>رفع بيانات العملاء</h2>
    <div class="form-container">
      <label for="agentSelect">اختر المندوب:</label>
      <select id="agentSelect">
        <option value="">-- اختر --</option>
      </select>
      <label for="sectionSelect">اختر القسم:</label>
      <select id="sectionSelect">
        <option value="">-- اختر القسم --</option>
      </select>
      <label for="excelFile">ملف Excel:</label>
      <input type="file" id="excelFile" accept=".xls,.xlsx" />
      <button id="excelUploadButton">📤 رفع البيانات</button>
      <div id="uploadStatus"></div>
      <div id="uploadLoader" style="display: none">⏳ جاري رفع البيانات...</div>
    </div> -->
    <!-- إضافة قسم جديد -->

    <!-- =========================== اختيار مندوب =========================== -->
    <div id="adminAgentSelectContainer">
      <h3>👔 اختر مندوب لعرض الجدول</h3>
      <select id="adminAgentSelect">
        <option value="">-- اختر مندوب --</option>
      </select>
    </div>

    <!-- =========================== الجدول القابل للتعديل =========================== -->
    <table id="adminCustomersTable">
      <thead>
        <tr>
          <th>القسم</th>
          <th>اسم العميل</th>
          <th>الهاتف</th>
          <th>العنوان</th>
          <th>المبلغ</th>
          <th>الحالة</th>
          <th>حفظ</th>
        </tr>
      </thead>

      <tbody></tbody>
    </table>

    <!-- =========== حذف البيانات =========== -->
    <h2>حذف كل البيانات</h2>
    <button id="clearButton">🧨 حذف جميع البيانات</button>
    <div id="clearStatus"></div>

    <!-- =========== فورم إضافة مندوب =========== -->
    <div id="addAgentContainer">
      <h3>➕ إضافة مندوب</h3>
      <div id="addAgentAlert"></div>
      <input id="newAgentName" placeholder="اسم المندوب" />
      <input id="newAgentEmail" placeholder="البريد الإلكتروني" />
      <input id="newAgentPassword" placeholder="كلمة المرور" />
      <select id="newAgentRole">
        <option value="agent">مندوب</option>
        <option value="admin">أدمن</option>
      </select>
      <button id="addAgentButton">➕ إضافة مندوب</button>
    </div>

    <!-- =========== الفوتر =========== -->
    <footer
      style="
        background: #2c3e50;
        color: #fff;
        text-align: center;
        padding: 15px;
        font-size: 14px;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        margin-top: 40px;
      "
    >
      <div>جميع الحقوق محفوظة &copy; فوكس بيزنيس</div>
      <div>مطور النظام: عبدالله هاني</div>
      <div>خدمة العملاء: 01212555345</div>
    </footer>

    <!-- =========== الجافا سكربت =========== -->
    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const supabase = createClient(
        "https://vyhtsdqccyvygelekzey.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5aHRzZHFjY3l2eWdlbGVremV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTQwOTMsImV4cCI6MjA2NTMzMDA5M30.bRjHD6OkziXjfavEX-tA-6IFdag7KoFBqLRgNLqwcdg"
      );

      // =========== عند تحميل الصفحة ===========
      window.addEventListener("load", async () => {
        await loadAgentsForAdmin();
        const adminAgentSelect = document.getElementById("adminAgentSelect");
        adminAgentSelect?.addEventListener("change", (e) => {
          if (e.target.value) {
            loadCustomersForAdmin(e.target.value);
          }
        });
      });

      // =========== تحميل قائمة المندوبين للمدير ===========
      async function loadAgentsForAdmin() {
        const select = document.getElementById("adminAgentSelect");
        if (!select) return;

        const { data: agents, error } = await supabase
          .from("agents")
          .select("*");
        if (error) {
          console.error(error);
          return;
        }

        select.innerHTML = '<option value="">-- اختر مندوب --</option>';
        agents.forEach((agent) => {
          const option = document.createElement("option");
          option.value = agent.id;
          option.textContent = agent.name;
          select.appendChild(option);
        });
      }

      // =========== تحميل العملاء على الجدول وتقسيمهم على حسب القسم ===========
      async function loadCustomersForAdmin(agent_id) {
        const tableBody = document.querySelector("#adminCustomersTable tbody");
        tableBody.innerHTML = ""; // مسح الجدول قبل التعبئة

        const { data: customers, error } = await supabase
          .from("customers")
          .select("*")
          .eq("agent_id", agent_id)
          .order("section", { ascending: true });

        if (error) {
          alert("❌ حدث خطأ أثناء جلب العملاء");
          console.error(error);
          return;
        }

        if (!customers.length) {
          tableBody.innerHTML = '<tr><td colspan="7">لا توجد عملاء</td></tr>';
          return;
        }

        const groupedCustomers = customers.reduce((acc, cust) => {
          const section = cust.section || "غير محدد";
          if (!acc[section]) acc[section] = [];
          acc[section].push(cust);
          return acc;
        }, {});

        for (const sectionName in groupedCustomers) {
          // سطر عنوان القسم
          const sectionRow = document.createElement("tr");
          sectionRow.innerHTML = `
      <td colspan="7" style="background-color:#34495e;color:#fff">
        📁 ${sectionName}
        <input value="${sectionName}" data-oldname="${sectionName}" class="editSectionInput" />
        <button class="saveSectionBtn" data-oldname="${sectionName}">💾 حفظ القسم</button>
        <button class="addCustomerToSectionBtn" data-section="${sectionName}">➕ إضافة عميل</button>
      </td>`;
          tableBody.appendChild(sectionRow);

          // سطور العملاء
          groupedCustomers[sectionName].forEach((cust) => {
            const row = document.createElement("tr");
            row.innerHTML = `
        <td>${cust.section}</td>
        <td><input value="${cust.name}" data-id="${
              cust.id
            }" data-field="name"/></td>
        <td><input value="${cust.phone}" data-id="${
              cust.id
            }" data-field="phone"/></td>
        <td><input value="${cust.address || ""}" data-id="${
              cust.id
            }" data-field="address"/></td>
        <td><input value="${cust.due_amount}" data-id="${
              cust.id
            }" data-field="due_amount" type="number"/></td>
        <td>
            <select data-id="${cust.id}" data-field="collection_status">
              <option ${
                cust.collection_status === "تم التحصيل" ? "selected" : ""
              }>تم التحصيل</option>
              <option ${
                cust.collection_status !== "تم التحصيل" ? "selected" : ""
              }>لم يتم التحصيل</option>
            </select>
        </td>
        <td>
            <button data-id="${cust.id}" class="saveCustomerBtn">💾 حفظ</button>
            <button data-id="${
              cust.id
            }" class="deleteCustomerBtn">🗑️ حذف</button>
        </td>`;
            tableBody.appendChild(row);
          });
        }
      }

      // =========== حفظ تعديل اسم القسم ===========
      document
        .querySelector("#adminCustomersTable")
        ?.addEventListener("click", async (e) => {
          if (e.target.classList.contains("saveSectionBtn")) {
            const oldName = e.target.getAttribute("data-oldname");
            const newName = e.target
              .closest("tr")
              .querySelector(".editSectionInput")
              .value.trim();
            if (!newName) return alert("❌ برجاء إدخال اسم القسم الجديد");

            const { error } = await supabase
              .from("customers")
              .update({ section: newName })
              .eq("section", oldName);

            if (error) {
              alert("❌ حدث خطأ أثناء تحديث القسم");
              console.error(error);
            } else {
              alert("✅ تم تحديث القسم بنجاح");
              loadCustomersForAdmin(
                document.getElementById("adminAgentSelect").value
              );
            }
          }
        });

      // =========== إضافة عميل لقسم محدد ===========
      document
        .querySelector("#adminCustomersTable")
        ?.addEventListener("click", async (e) => {
          if (e.target.classList.contains("addCustomerToSectionBtn")) {
            const section = e.target.getAttribute("data-section"); // ✅ نأخذ القسم من العنصر
            const agent_id = document.getElementById("adminAgentSelect").value;

            const name = prompt(`👤 أدخل اسم العميل لقسم "${section}"`);
            const phone = prompt(`📞 أدخل رقم الهاتف:`);
            const address = prompt(`🏠 أدخل عنوان العميل:`);
            const due_amount = parseFloat(prompt(`💵 أدخل المبلغ المستحق:`));

            if (!name || !phone || !address || !due_amount) {
              alert("❌ برجاء ملء جميع الحقول");
              return;
            }

            const { error } = await supabase.from("customers").insert([
              {
                agent_id,
                section,
                name,
                phone,
                address,
                due_amount,
                billing_month: new Date().toISOString().slice(0, 7),
                collection_status: "لم يتم التحصيل",
              },
            ]);

            if (error) {
              alert("❌ حدث خطأ أثناء إضافة العميل");
              console.error(error);
            } else {
              alert("✅ تم إضافة العميل بنجاح");
              loadCustomersForAdmin(agent_id);
            }
          }

          // =========== حفظ تعديلات العملاء ===========
          document
            .querySelector("#adminCustomersTable")
            ?.addEventListener("click", async (e) => {});

          if (e.target.classList.contains("saveCustomerBtn")) {
            const id = e.target.getAttribute("data-id");
            const inputs = document.querySelectorAll(`[data-id="${id}"]`);

            const updatedData = {};
            inputs.forEach((input) => {
              updatedData[input.getAttribute("data-field")] =
                input.value.trim();
            });
            if (updatedData.due_amount) {
              updatedData.due_amount = Number(updatedData.due_amount);
            }

            const { error } = await supabase
              .from("customers")
              .update(updatedData)
              .eq("id", id);
            if (error) {
              alert("❌ حدث خطأ أثناء حفظ التعديلات");
              console.error(error);
            } else {
              alert("✅ تم حفظ التعديلات بنجاح");
            }
          }
        });

      // =========== حذف العميل ===========
      document
        .querySelector("#adminCustomersTable")
        ?.addEventListener("click", async (e) => {
          if (e.target.classList.contains("deleteCustomerBtn")) {
            const id = e.target.getAttribute("data-id");
            if (!confirm("❓ هل أنت متأكد من حذف هذا العميل؟")) return;

            const { error } = await supabase
              .from("customers")
              .delete()
              .eq("id", id);
            if (error) {
              alert("❌ حدث خطأ أثناء الحذف");
              console.error(error);
            } else {
              alert("✅ تم الحذف بنجاح");
              loadCustomersForAdmin(
                document.getElementById("adminAgentSelect").value
              );
            }
          }
        });
    </script>
  </body>
</html>
