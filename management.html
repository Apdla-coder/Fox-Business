<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>رفع البيانات وإدارة المناديب</title>
    <link rel="stylesheet" href="./header.css" />
    <style>
      /* =========== الشكل الأساسي =========== */
      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #2c3e50, #4ca1af);
        color: #f5f5f5;
        padding: 20px;
        max-width: 800px;
        margin: auto;
        line-height: 1.5;
      }

      /* =========== العناوين =========== */
      h2,
      h3 {
        text-align: center;
        font-weight: bold;
        margin: 15px 0;
      }
      h2 {
        font-size: 1.3rem;
        color: #fffae3;
      }
      h3 {
        font-size: 1.1rem;
        color: #fffae3;
      }

      /* =========== اللينكات =========== */
      a {
        color: #fffa90;
        text-decoration: none;
        font-weight: bold;
        transition: color 0.3s, text-decoration 0.3s;
      }
      a:hover {
        text-decoration: underline;
        color: #ffe97f;
      }

      /* =========== الحاويات العامة =========== */
      #addAgentContainer,
      .form-container {
        margin: 25px auto;
        padding: 20px;
        background-color: rgba(255, 255, 255, 0.08);
        border-radius: 6px;
        box-shadow: 0px 4px 15px rgba(255, 255, 255, 0.1);
      }

      /* =========== الفورم على سطرين =========== */
      .form-row {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 20px;
      }
      .form-group {
        flex: 1 1 48%;
        display: flex;
        flex-direction: column;
        margin-bottom: 15px;
      }
      label {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 5px;
        color: #fffae3;
      }
      select,
      input,
      button {
        padding: 9px 12px;
        font-size: 0.95rem;
        border-radius: 4px;
        border: none;
        outline: none;
        transition: box-shadow 0.3s;
      }
      select,
      input {
        width: 80%; /* مريح على الديسكتوب */
        margin-bottom: 20px;
      }
      select:focus,
      input:focus {
        box-shadow: 0px 0px 8px rgba(255, 250, 227, 0.5);
      }

      /* =========== الجدول =========== */
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        margin: 20px 0;
        border-radius: 8px;
        overflow: hidden;
      }
      table thead {
        background-color: rgba(255, 255, 255, 0.15);
      }
      table th,
      table td {
        padding: 8px;
        text-align: center;
        border-bottom: 1px solid #888;
      }
      table tr:hover {
        background-color: rgba(255, 255, 255, 0.07);
      }

      /* =========== الأزرار =========== */
      button {
        cursor: pointer;
        font-weight: bold;
        background-color: #fffae3;
        color: #2c3e50;
        margin: 5px 0;
        padding: 9px 15px;
        border-radius: 5px;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #ffe97f;
      }

      /* =========== الرسائل وحالة التحديث =========== */
      #uploadLoader {
        font-size: 14px;
        color: #ffe97f;
      }
      #addAgentAlert,
      #uploadStatus,
      #clearStatus {
        margin: 10px 0;
        padding: 8px;
        font-size: 13px;
        font-weight: bold;
        border-radius: 4px;
        text-align: center;
      }
      #addAgentAlert {
        display: none;
      }

      /* =========== موبايل =========== */
      @media (max-width: 768px) {
        .form-group {
          flex: 1 1 100%; /* عنصر كامل على السطر على موبايل */
        }
        select,
        input {
          width: 100%; /* مريح على موبايل */
        }
      }
    </style>
  </head>
  <body>
    <!-- =========== الهيدر =========== -->
    <header>
      <div class="logo-container">
        <a href="./index.html">
          <img src="./Orange_logo.svg.png" alt="Logo" />
        </a>
        <h2 style="margin: 0">فوكس بيزنيس</h2>
      </div>

      <!-- زر التوجال -->
      <button class="toggle-btn" onclick="toggleMenu()">☰</button>

      <!-- القائمة المنسدلة -->
      <div id="navMenu" class="nav-menu">
        <a href="./management.html"> تعديل بيانات العملاء ⬅</a>
        <a href="./agents_performance.html">أداء المناديب ⬅</a>
        <a href="./dashboard.html">لوحة التحكم ⬅</a>
        <a href="./disconnected_lines.html">الخطوط المتوقفة ⬅</a>
        <a href="./notes.html">ملاحظات المناديب ⬅</a>
        <a href="./admin.html"> ادارة المناديب ⬅</a>
      </div>
    </header>
    <script src="./header.js"></script>
    <!-- =========================== اختيار مندوب =========================== -->
    <div id="adminAgentSelectContainer">
      <h3>👔 اختر مندوب لعرض الجدول</h3>
      <select id="adminAgentSelect">
        <option value="">-- اختر مندوب --</option>
      </select>
    </div>
    <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap">
      <select id="sectionFilter" style="padding: 8px; font-size: 16px">
        <option value="all">📂 عرض جميع الأقسام</option>
      </select>

      <input
        type="text"
        id="searchInput"
        placeholder="🔍 ابحث عن عميل بالاسم أو الرقم"
        style="
          flex-grow: 1;
          padding: 8px;
          font-size: 16px;
          border: 1px solid #ccc;
        "
      />
    </div>

    <!-- =========================== الجدول القابل للتعديل =========================== -->
    <table id="adminCustomersTable">
      <thead>
        <tr>
          <th>القسم</th>
          <th>اسم العميل</th>
          <th>الهاتف</th>
          <th>العنوان</th>
          <th>المبلغ</th>
          <th>الحالة</th>
          <th>حفظ</th>
        </tr>
      </thead>

      <tbody></tbody>
    </table>

    <!-- =========== حذف البيانات =========== -->
    <h2>حذف كل البيانات</h2>
    <button id="clearButton">🧨 حذف جميع البيانات</button>
    <div id="clearStatus"></div>

    <!-- =========== الفوتر =========== -->
    <footer
      style="
        background: #2c3e50;
        color: #fff;
        text-align: center;
        padding: 15px;
        font-size: 14px;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        margin-top: 40px;
      "
    >
      <div>جميع الحقوق محفوظة &copy; فوكس بيزنيس</div>
      <div>مطور النظام: عبدالله هاني</div>
      <div>خدمة العملاء: 01212555345</div>
    </footer>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const supabase = createClient(
        "https://vyhtsdqccyvygelekzey.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5aHRzZHFjY3l2eWdlbGVremV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTQwOTMsImV4cCI6MjA2NTMzMDA5M30.bRjHD6OkziXjfavEX-tA-6IFdag7KoFBqLRgNLqwcdg"
      );

      window.addEventListener("load", async () => {
        await loadAgentsForAdmin();
        document
          .getElementById("adminAgentSelect")
          ?.addEventListener("change", (e) => {
            if (e.target.value) {
              loadCustomersForAdmin(e.target.value);
            }
          });
      });

      async function loadAgentsForAdmin() {
        const select = document.getElementById("adminAgentSelect");
        if (!select) return;

        const { data: agents, error } = await supabase
          .from("agents")
          .select("*");
        if (error) return console.error(error);

        select.innerHTML = '<option value="">-- اختر مندوب --</option>';
        agents.forEach((agent) => {
          const option = document.createElement("option");
          option.value = agent.id;
          option.textContent = agent.name;
          select.appendChild(option);
        });
      }

      async function loadCustomersForAdmin(agent_id) {
        const tableBody = document.querySelector("#adminCustomersTable tbody");
        tableBody.innerHTML = "";

        const { data: customers, error } = await supabase
          .from("customers")
          .select("*")
          .eq("agent_id", agent_id)
          .order("section", { ascending: true });

        if (error) return alert("❌ حدث خطأ أثناء جلب العملاء");
        if (!customers.length) {
          tableBody.innerHTML = '<tr><td colspan="7">لا توجد عملاء</td></tr>';
          return;
        }

        const groupedCustomers = customers.reduce((acc, cust) => {
          const section = cust.section || "غير محدد";
          if (!acc[section]) acc[section] = [];
          acc[section].push(cust);
          return acc;
        }, {});

        for (const sectionName in groupedCustomers) {
          const sectionRow = document.createElement("tr");
          sectionRow.innerHTML = `
<td colspan="7" style="background-color:#34495e;color:#fff">
📁 ${sectionName}
<input value="${sectionName}" data-oldname="${sectionName}" class="editSectionInput" />
<button class="saveSectionBtn" data-oldname="${sectionName}">💾 حفظ القسم</button>
<button class="addCustomerToSectionBtn" data-section="${sectionName}">➕ إضافة عميل</button>
</td>`;
          tableBody.appendChild(sectionRow);

          groupedCustomers[sectionName].forEach((cust) => {
            const row = document.createElement("tr");
            row.innerHTML = `
<td>${cust.section}</td>
<td><input value="${cust.name}" data-id="${cust.id}" data-field="name"/></td>
<td><input value="${cust.phone}" data-id="${cust.id}" data-field="phone"/></td>
<td><input value="${cust.address || ""}" data-id="${
              cust.id
            }" data-field="address"/></td>
<td><input type="number" value="${cust.due_amount}" data-id="${
              cust.id
            }" data-field="due_amount"/></td>
<td>
  <select data-id="${cust.id}" data-field="collection_status">
    <option ${
      cust.collection_status === "تم التحصيل" ? "selected" : ""
    }>تم التحصيل</option>
    <option ${
      cust.collection_status !== "تم التحصيل" ? "selected" : ""
    }>لم يتم التحصيل</option>
  </select>
</td>
<td>
  <button class="saveCustomerBtn" data-id="${cust.id}">💾 حفظ</button>
  <button class="deleteCustomerBtn" data-id="${cust.id}">🗑️ حذف</button>
</td>`;
            tableBody.appendChild(row);
          });
        }

        populateSectionFilter(customers);
      }

      function populateSectionFilter(customers) {
        const select = document.getElementById("sectionFilter");
        if (!select) return;

        const uniqueSections = new Set(
          customers.map((c) => c.section || "غير محدد")
        );
        select.innerHTML = '<option value="all">📂 عرض جميع الأقسام</option>';
        uniqueSections.forEach((section) => {
          const option = document.createElement("option");
          option.value = section;
          option.textContent = section;
          select.appendChild(option);
        });
      }

      document
        .getElementById("searchInput")
        ?.addEventListener("keyup", applyFilters);
      document
        .getElementById("sectionFilter")
        ?.addEventListener("change", applyFilters);

      function applyFilters() {
        const filter = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const selectedSection = document.getElementById("sectionFilter").value;
        const rows = document.querySelectorAll("#adminCustomersTable tbody tr");

        let showSection = true;
        rows.forEach((row) => {
          const isSectionRow = row.querySelector("td")?.colSpan === 7;
          if (isSectionRow) {
            const sectionText = row.textContent.trim();
            showSection =
              selectedSection === "all" ||
              sectionText.includes(selectedSection);
            row.style.display = showSection ? "" : "none";
          } else {
            if (!showSection) {
              row.style.display = "none";
              return;
            }
            const name =
              row.cells[1]?.querySelector("input")?.value.toLowerCase() || "";
            const phone =
              row.cells[2]?.querySelector("input")?.value.toLowerCase() || "";
            row.style.display =
              name.includes(filter) || phone.includes(filter) ? "" : "none";
          }
        });
      }

      document
        .querySelector("#adminCustomersTable")
        ?.addEventListener("click", async (e) => {
          const id = e.target.getAttribute("data-id");

          if (e.target.classList.contains("saveCustomerBtn")) {
            const row = e.target.closest("tr");
            const inputs = row.querySelectorAll("[data-field]");

            const updatedData = {};
            inputs.forEach((input) => {
              const field = input.getAttribute("data-field");
              updatedData[field] = input.value.trim();
            });
            if (updatedData.due_amount) {
              updatedData.due_amount = Number(updatedData.due_amount);
            }

            const { error } = await supabase
              .from("customers")
              .update(updatedData)
              .eq("id", id);
            if (error) {
              alert("❌ حدث خطأ أثناء حفظ التعديلات");
            } else {
              e.target.textContent = "✅ تم";
              setTimeout(() => (e.target.textContent = "💾 حفظ"), 1500);
            }
          }

          if (e.target.classList.contains("deleteCustomerBtn")) {
            if (confirm("⚠️ هل تريد حذف العميل؟")) {
              const { error } = await supabase
                .from("customers")
                .delete()
                .eq("id", id);
              if (error) alert("❌ حدث خطأ أثناء الحذف");
              else e.target.closest("tr").remove();
            }
          }

          if (e.target.classList.contains("saveSectionBtn")) {
            const oldName = e.target.getAttribute("data-oldname");
            const input =
              e.target.parentElement.querySelector(".editSectionInput");
            const newName = input.value.trim();
            if (!newName || newName === oldName) return;

            const { error } = await supabase
              .from("customers")
              .update({ section: newName })
              .eq("section", oldName);
            if (error) alert("❌ فشل تعديل اسم القسم");
            else {
              alert("✅ تم تعديل القسم بنجاح");
              loadCustomersForAdmin(
                document.getElementById("adminAgentSelect").value
              );
            }
          }

          if (e.target.classList.contains("addCustomerToSectionBtn")) {
            const section = e.target.getAttribute("data-section");
            const agent_id = document.getElementById("adminAgentSelect").value;
            if (!agent_id) return alert("❌ لم يتم اختيار مندوب");

            const name = prompt("أدخل اسم العميل:");
            if (!name) return;

            const phone = prompt("رقم الهاتف:");
            const address = prompt("العنوان:");
            const due_amount = prompt("المبلغ المستحق:", "0");

            const { error } = await supabase.from("customers").insert({
              name,
              phone,
              address,
              due_amount: Number(due_amount),
              section,
              agent_id,
              collection_status: "لم يتم التحصيل",
            });

            if (error) alert("❌ فشل في إضافة العميل");
            else {
              alert("✅ تم إضافة العميل بنجاح");
              loadCustomersForAdmin(agent_id);
            }
          }
        });
      document
        .getElementById("clearButton")
        ?.addEventListener("click", async () => {
          if (confirm("⚠️ هل تريد حذف كل العملاء؟")) {
            const { error } = await supabase
              .from("customers")
              .delete()
              .neq("id", 0);
            const status = document.getElementById("clearStatus");

            if (error) {
              status.textContent = "❌ فشل الحذف";
              status.style.color = "red";
            } else {
              status.textContent = "✅ تم حذف كل البيانات";
              status.style.color = "lightgreen";
              document.querySelector("#adminCustomersTable tbody").innerHTML =
                "";
            }
          }
        });
    </script>
  </body>
</html>
