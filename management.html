<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="./header.css" />
    <style>
      /* Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #2c3e50, #4ca1af);
        color: #f5f5f5;
        padding: 20px;
        max-width: 1200px;
        margin: auto;
        line-height: 1.6;
      }

      /* Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
      h2 {
        text-align: center;
        color: #fffae3;
        margin-bottom: 30px;
      }

      /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
      input,
      select,
      button {
        padding: 8px 12px;
        font-size: 0.9rem;
        border-radius: 6px;
        border: none;
        margin: 5px 0;
        outline: none;
      }

      button {
        cursor: pointer;
        font-weight: bold;
        background-color: #fffae3;
        color: #2c3e50;
        transition: background-color 0.3s ease;
      }

      button:hover {
        background-color: #eae3be;
      }

      /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© */
      div > input,
      div > select,
      div > button {
        margin: 10px 10px 10px 0;
        display: inline-block;
      }

      /* Ø§Ù„Ø¨Ø­Ø« + Ø§Ù„ÙÙ„Ø§ØªØ± */
      #searchInput {
        width: 250px;
      }
      #newSectionName {
        width: 200px;
      }

      /* Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
      .section-block {
        margin-top: 30px;
        background: rgba(255, 255, 255, 0.07);
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }

      /* Ø±Ø£Ø³ ÙƒÙ„ Ù‚Ø³Ù… */
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #34495e;
        padding: 10px;
        border-radius: 8px;
        flex-wrap: wrap;
      }

      .section-header h3 {
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0;
      }

      .section-header input {
        font-size: 1rem;
        padding: 6px;
        border-radius: 6px;
        width: 180px;
      }

      /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        margin-top: 10px;
      }

      th,
      td {
        padding: 10px;
        text-align: center;
        border-bottom: 1px solid #888;
        background-color: rgba(255, 255, 255, 0.06);
      }

      th {
        background-color: rgba(255, 255, 255, 0.15);
        font-weight: bold;
      }

      table input,
      table select {
        width: 100%;
        padding: 6px;
        border-radius: 4px;
        border: none;
        background-color: #fff;
        color: #000;
      }

      /* Ø²Ø± Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø­Ø°Ù ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
      td button {
        padding: 6px 10px;
        font-size: 1rem;
        border-radius: 6px;
      }

      /* Ø§Ù„ÙÙˆØªØ± */
      footer {
        background: #2c3e50;
        color: #fff;
        text-align: center;
        padding: 15px;
        font-size: 14px;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        margin-top: 40px;
      }

      /* Ø§Ù„Ù‡ÙˆØ§ØªÙ */
      @media (max-width: 768px) {
        .section-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .section-header input {
          width: 100%;
        }

        #searchInput,
        #newSectionName {
          width: 100%;
        }

        table {
          font-size: 0.85rem;
        }

        th,
        td {
          padding: 6px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="logo-container">
        <a href="./index.html">
          <img src="./Orange_logo.svg.png" alt="Logo" />
        </a>
        <h2 style="margin: 0">ÙÙˆÙƒØ³ Ø¨ÙŠØ²Ù†ÙŠØ³</h2>
      </div>

      <!-- Ø²Ø± Ø§Ù„ØªÙˆØ¬Ø§Ù„ -->
      <button class="toggle-btn" onclick="toggleMenu()">â˜°</button>

      <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© -->
      <div id="navMenu" class="nav-menu">
        <a href="./management.html"> Ø§Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ â¬…</a>
        <a href="./agents_performance.html">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ â¬…</a>
        <a href="./dashboard.html">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â¬…</a>
        <a href="./disconnected_lines.html">Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ù…ØªÙˆÙ‚ÙØ© â¬…</a>
        <a href="./notes.html">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ â¬…</a>
        <a href="./admin.html"> Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ â¬…</a>
      </div>
    </header>
    <script src="./header.js"></script>

    <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>

    <div>
      <label>Ø§Ø®ØªØ± Ù…Ù†Ø¯ÙˆØ¨:</label>
      <select id="adminAgentSelect">
        <option value="">-- Ø§Ø®ØªØ± --</option>
      </select>
    </div>

    <div>
      <input id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ" />
      <select id="sectionFilter">
        <option value="all">ğŸ“ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
      </select>
      <button id="exportExcel">ğŸ“¤ ØªØµØ¯ÙŠØ± Excel</button>
    </div>

    <div>
      <input id="newSectionName" placeholder="â• Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯" />
      <button id="addSectionBtn">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</button>
    </div>

    <div id="sectionsContainer"></div>

    <button id="clearButton">ğŸ§¨ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
    <!-- Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ø£Ø¹Ù„Ù‰ -->
    <button
      id="scrollToTopBtn"
      style="
        position: fixed;
        bottom: 30px;
        left: 30px;
        font-size: 30px;
        padding: 12px 14px;
        border-radius: 50%;
        border: none;
        background-color: #3498db;
        color: #fff;
        cursor: pointer;
        display: none;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        z-index: 1001;
      "
    >
      â¬†ï¸
    </button>
    <script>
      const scrollBtn = document.getElementById("scrollToTopBtn");
      window.onscroll = () => {
        scrollBtn.style.display = window.scrollY > 300 ? "block" : "none";
      };
      scrollBtn.onclick = () => window.scrollTo({ top: 0, behavior: "smooth" });
    </script>

    <!-- =========== Ø§Ù„ÙÙˆØªØ± =========== -->
    <footer>
      <div>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; ÙÙˆÙƒØ³ Ø¨ÙŠØ²Ù†ÙŠØ³</div>
      <div>Ù…Ø·ÙˆØ± Ø§Ù„Ù†Ø¸Ø§Ù…: Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù‡Ø§Ù†ÙŠ</div>
      <div>Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: 01212555345</div>
    </footer>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const supabase = createClient(
        "https://vyhtsdqccyvygelekzey.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5aHRzZHFjY3l2eWdlbGVremV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTQwOTMsImV4cCI6MjA2NTMzMDA5M30.bRjHD6OkziXjfavEX-tA-6IFdag7KoFBqLRgNLqwcdg"
      );

      const agentSelect = document.getElementById("adminAgentSelect");
      const sectionFilter = document.getElementById("sectionFilter");
      const searchInput = document.getElementById("searchInput");
      const container = document.getElementById("sectionsContainer");
      let currentCustomers = [];

      window.addEventListener("load", async () => {
        const { data: agents } = await supabase
          .from("agents")
          .select("id, name");
        agents?.forEach((a) => {
          const opt = document.createElement("option");
          opt.value = a.id;
          opt.textContent = a.name;
          agentSelect.appendChild(opt);
        });
      });

      agentSelect.addEventListener("change", loadCustomersByAgent);

      async function loadCustomersByAgent() {
        const agentId = agentSelect.value;
        if (!agentId) return;
        const { data: customers } = await supabase
          .from("customers")
          .select("*")
          .eq("agent_id", agentId);
        currentCustomers = customers || [];
        renderSections(currentCustomers);
        updateSectionFilter(currentCustomers);
      }

      function groupBySection(data) {
        return data.reduce((acc, cust) => {
          const sec = cust.section || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
          acc[sec] = acc[sec] || [];
          acc[sec].push(cust);
          return acc;
        }, {});
      }

      function renderSections(customers) {
        container.innerHTML = "";
        const grouped = groupBySection(customers);

        for (const section in grouped) {
          const block = document.createElement("div");
          block.className = "section-block";

          const safeId = section.replace(/[^\w\-]/g, "-");
          const inputId = `sectionInput-${safeId}`;
          const saveBtnId = `saveBtn-${safeId}`;

          block.innerHTML = `
            <div class="section-header">
              <h3>ğŸ“ <input id="${inputId}" value="${section}" /> 
              <button id="${saveBtnId}">ğŸ’¾ Ø­ÙØ¸</button></h3>
              <button onclick="addCustomer('${section}')">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
            </div>
            <table>
              <thead>
                <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>ğŸ’¾</th><th>ğŸ—‘ï¸</th></tr>
              </thead>
              <tbody>
                ${grouped[section]
                  .map(
                    (c) => `
                  <tr>
                    <td><input data-id="${c.id}" data-field="name" value="${
                      c.name
                    }" /></td>
                    <td><input data-id="${c.id}" data-field="phone" value="${
                      c.phone
                    }" /></td>
                    <td><input data-id="${c.id}" data-field="address" value="${
                      c.address
                    }" /></td>
                    <td><input data-id="${
                      c.id
                    }" data-field="due_amount" type="number" value="${
                      c.due_amount
                    }" /></td>
                    <td>
                      <select data-id="${c.id}" data-field="collection_status">
                        <option ${
                          c.collection_status === "ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„" ? "selected" : ""
                        }>ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„</option>
                        <option ${
                          c.collection_status !== "ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„" ? "selected" : ""
                        }>Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„</option>
                      </select>
                    </td>
                    <td><button onclick="saveCustomer('${
                      c.id
                    }', this)">ğŸ’¾</button></td>
                    <td><button onclick="deleteCustomer('${
                      c.id
                    }', this)">ğŸ—‘ï¸</button></td>
                  </tr>
                `
                  )
                  .join("")}
              </tbody>
            </table>
          `;
          container.appendChild(block);

          setTimeout(() => {
            const input = document.getElementById(inputId);
            const saveBtn = document.getElementById(saveBtnId);
            if (input && saveBtn) {
              saveBtn.addEventListener("click", async () => {
                const newName = input.value.trim();
                if (!newName || newName === section) return;
                await supabase
                  .from("customers")
                  .update({ section: newName })
                  .eq("section", section);
                await loadCustomersByAgent();
              });
            }
          }, 0);
        }
      }

      window.saveCustomer = async (id, btn) => {
        const row = btn.closest("tr");
        const inputs = row.querySelectorAll("[data-field]");
        const updated = {};
        inputs.forEach((inp) => {
          updated[inp.dataset.field] =
            inp.dataset.field === "due_amount"
              ? Number(inp.value)
              : inp.value.trim();
        });
        updated.billing_month = new Date().toISOString().slice(0, 7);
        await supabase.from("customers").update(updated).eq("id", id);
        btn.textContent = "âœ…";
        setTimeout(() => (btn.textContent = "ğŸ’¾"), 1000);
      };

      window.deleteCustomer = async (id, btn) => {
        if (!confirm("âŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ")) return;
        await supabase.from("customers").delete().eq("id", id);
        await loadCustomersByAgent();
      };

      window.addCustomer = async (section) => {
        const agent_id = agentSelect.value;
        if (!agent_id) return alert("Ø§Ø®ØªØ± Ù…Ù†Ø¯ÙˆØ¨ Ø£ÙˆÙ„Ù‹Ø§");
        const name = prompt("Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:");
        if (!name) return;
        const phone = prompt("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:") || "";
        const address = prompt("Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:") || "";
        const due_amount = prompt("Ø§Ù„Ù…Ø¨Ù„Øº:", "0");

        await supabase.from("customers").insert({
          name,
          phone,
          address,
          due_amount: Number(due_amount),
          section,
          agent_id,
          billing_month: new Date().toISOString().slice(0, 7),
          collection_status: "Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„",
        });

        await loadCustomersByAgent();
      };

      searchInput.addEventListener("input", () => {
        const term = searchInput.value.toLowerCase();
        const filtered = currentCustomers.filter(
          (c) =>
            c.name.toLowerCase().includes(term) ||
            c.phone.toLowerCase().includes(term)
        );
        renderSections(filtered);
      });

      sectionFilter.addEventListener("change", () => {
        const selected = sectionFilter.value;
        const filtered =
          selected === "all"
            ? currentCustomers
            : currentCustomers.filter((c) => c.section === selected);
        renderSections(filtered);
      });

      function updateSectionFilter(customers) {
        const uniqueSections = [
          ...new Set(customers.map((c) => c.section || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯")),
        ];
        sectionFilter.innerHTML = '<option value="all">ğŸ“ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>';
        uniqueSections.forEach((sec) => {
          const opt = document.createElement("option");
          opt.value = sec;
          opt.textContent = sec;
          sectionFilter.appendChild(opt);
        });
      }

      document.getElementById("addSectionBtn").addEventListener("click", () => {
        const name = document.getElementById("newSectionName").value.trim();
        if (!name) return;
        addCustomer(name);
      });

      document.getElementById("exportExcel").addEventListener("click", () => {
        const ws = XLSX.utils.json_to_sheet(currentCustomers);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡");
        XLSX.writeFile(wb, "customers.xlsx");
      });

      document
        .getElementById("clearButton")
        .addEventListener("click", async () => {
          if (confirm("âš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ØŸ")) {
            await supabase
              .from("customers")
              .delete()
              .neq("id", "00000000-0000-0000-0000-000000000000");
            container.innerHTML = "";
          }
        });
    </script>
  </body>
</html>
