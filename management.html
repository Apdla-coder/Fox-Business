<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</title>
    <link rel="stylesheet" href="./header.css" />
    <style>
      /* =========== Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ =========== */
      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #2c3e50, #4ca1af);
        color: #f5f5f5;
        padding: 20px;
        max-width: 800px;
        margin: auto;
        line-height: 1.5;
      }

      /* =========== Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† =========== */
      h2,
      h3 {
        text-align: center;
        font-weight: bold;
        margin: 15px 0;
      }
      h2 {
        font-size: 1.3rem;
        color: #fffae3;
      }
      h3 {
        font-size: 1.1rem;
        color: #fffae3;
      }

      /* =========== Ø§Ù„Ù„ÙŠÙ†ÙƒØ§Øª =========== */
      a {
        color: #fffa90;
        text-decoration: none;
        font-weight: bold;
        transition: color 0.3s, text-decoration 0.3s;
      }
      a:hover {
        text-decoration: underline;
        color: #ffe97f;
      }

      /* =========== Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© =========== */
      #addAgentContainer,
      .form-container {
        margin: 25px auto;
        padding: 20px;
        background-color: rgba(255, 255, 255, 0.08);
        border-radius: 6px;
        box-shadow: 0px 4px 15px rgba(255, 255, 255, 0.1);
      }

      /* =========== Ø§Ù„ÙÙˆØ±Ù… Ø¹Ù„Ù‰ Ø³Ø·Ø±ÙŠÙ† =========== */
      .form-row {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 20px;
      }
      .form-group {
        flex: 1 1 48%;
        display: flex;
        flex-direction: column;
        margin-bottom: 15px;
      }
      label {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 5px;
        color: #fffae3;
      }
      select,
      input,
      button {
        padding: 9px 12px;
        font-size: 0.95rem;
        border-radius: 4px;
        border: none;
        outline: none;
        transition: box-shadow 0.3s;
      }
      select,
      input {
        width: 80%; /* Ù…Ø±ÙŠØ­ Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨ */
        margin-bottom: 20px;
      }
      select:focus,
      input:focus {
        box-shadow: 0px 0px 8px rgba(255, 250, 227, 0.5);
      }

      /* =========== Ø§Ù„Ø¬Ø¯ÙˆÙ„ =========== */
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        margin: 20px 0;
        border-radius: 8px;
        overflow: hidden;
      }
      table thead {
        background-color: rgba(255, 255, 255, 0.15);
      }
      table th,
      table td {
        padding: 8px;
        text-align: center;
        border-bottom: 1px solid #888;
      }
      table tr:hover {
        background-color: rgba(255, 255, 255, 0.07);
      }

      /* =========== Ø§Ù„Ø£Ø²Ø±Ø§Ø± =========== */
      button {
        cursor: pointer;
        font-weight: bold;
        background-color: #fffae3;
        color: #2c3e50;
        margin: 5px 0;
        padding: 9px 15px;
        border-radius: 5px;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #ffe97f;
      }

      /* =========== Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ­Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« =========== */
      #uploadLoader {
        font-size: 14px;
        color: #ffe97f;
      }
      #addAgentAlert,
      #uploadStatus,
      #clearStatus {
        margin: 10px 0;
        padding: 8px;
        font-size: 13px;
        font-weight: bold;
        border-radius: 4px;
        text-align: center;
      }
      #addAgentAlert {
        display: none;
      }

      /* =========== Ù…ÙˆØ¨Ø§ÙŠÙ„ =========== */
      @media (max-width: 768px) {
        .form-group {
          flex: 1 1 100%; /* Ø¹Ù†ØµØ± ÙƒØ§Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø·Ø± Ø¹Ù„Ù‰ Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        }
        select,
        input {
          width: 100%; /* Ù…Ø±ÙŠØ­ Ø¹Ù„Ù‰ Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        }
      }
    </style>
  </head>
  <body>
    <!-- =========== Ø§Ù„Ù‡ÙŠØ¯Ø± =========== -->
    <header>
      <div class="logo-container">
        <a href="./index.html">
          <img src="./Orange_logo.svg.png" alt="Logo" />
        </a>
        <h2 style="margin: 0">ÙÙˆÙƒØ³ Ø¨ÙŠØ²Ù†ÙŠØ³</h2>
      </div>

      <!-- Ø²Ø± Ø§Ù„ØªÙˆØ¬Ø§Ù„ -->
      <button class="toggle-btn" onclick="toggleMenu()">â˜°</button>

      <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© -->
      <div id="navMenu" class="nav-menu">
        <a href="./management.html"> ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ â¬…</a>
        <a href="./agents_performance.html">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ â¬…</a>
        <a href="./dashboard.html">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â¬…</a>
        <a href="./disconnected_lines.html">Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ù…ØªÙˆÙ‚ÙØ© â¬…</a>
        <a href="./notes.html">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ â¬…</a>
        <a href="./admin.html"> Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ â¬…</a>
      </div>
    </header>
    <script src="./header.js"></script>
    <!-- =========================== Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ø¯ÙˆØ¨ =========================== -->
    <div id="adminAgentSelectContainer">
      <h3>ğŸ‘” Ø§Ø®ØªØ± Ù…Ù†Ø¯ÙˆØ¨ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„</h3>
      <select id="adminAgentSelect">
        <option value="">-- Ø§Ø®ØªØ± Ù…Ù†Ø¯ÙˆØ¨ --</option>
      </select>
    </div>
    <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap">
      <select id="sectionFilter" style="padding: 8px; font-size: 16px">
        <option value="all">ğŸ“‚ Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
      </select>

      <input
        type="text"
        id="searchInput"
        placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…"
        style="
          flex-grow: 1;
          padding: 8px;
          font-size: 16px;
          border: 1px solid #ccc;
        "
      />
    </div>

    <!-- =========================== Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ =========================== -->
    <table id="adminCustomersTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ù‚Ø³Ù…</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
          <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
          <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø­ÙØ¸</th>
        </tr>
      </thead>

      <tbody></tbody>
    </table>

    <!-- =========== Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =========== -->
    <h2>Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
    <button id="clearButton">ğŸ§¨ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    <div id="clearStatus"></div>

    <!-- =========== Ø§Ù„ÙÙˆØªØ± =========== -->
    <footer
      style="
        background: #2c3e50;
        color: #fff;
        text-align: center;
        padding: 15px;
        font-size: 14px;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        margin-top: 40px;
      "
    >
      <div>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; ÙÙˆÙƒØ³ Ø¨ÙŠØ²Ù†ÙŠØ³</div>
      <div>Ù…Ø·ÙˆØ± Ø§Ù„Ù†Ø¸Ø§Ù…: Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù‡Ø§Ù†ÙŠ</div>
      <div>Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: 01212555345</div>
    </footer>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const supabase = createClient(
        "https://vyhtsdqccyvygelekzey.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5aHRzZHFjY3l2eWdlbGVremV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTQwOTMsImV4cCI6MjA2NTMzMDA5M30.bRjHD6OkziXjfavEX-tA-6IFdag7KoFBqLRgNLqwcdg"
      );

      window.addEventListener("load", async () => {
        await loadAgentsForAdmin();
        document
          .getElementById("adminAgentSelect")
          ?.addEventListener("change", (e) => {
            if (e.target.value) {
              loadCustomersForAdmin(e.target.value);
            }
          });
      });

      async function loadAgentsForAdmin() {
        const select = document.getElementById("adminAgentSelect");
        if (!select) return;

        const { data: agents, error } = await supabase
          .from("agents")
          .select("*");
        if (error) return console.error(error);

        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ù†Ø¯ÙˆØ¨ --</option>';
        agents.forEach((agent) => {
          const option = document.createElement("option");
          option.value = agent.id;
          option.textContent = agent.name;
          select.appendChild(option);
        });
      }

      async function loadCustomersForAdmin(agent_id) {
        const tableBody = document.querySelector("#adminCustomersTable tbody");
        tableBody.innerHTML = "";

        const { data: customers, error } = await supabase
          .from("customers")
          .select("*")
          .eq("agent_id", agent_id)
          .order("section", { ascending: true });

        if (error) return alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡");
        if (!customers.length) {
          tableBody.innerHTML = '<tr><td colspan="7">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡</td></tr>';
          return;
        }

        const groupedCustomers = customers.reduce((acc, cust) => {
          const section = cust.section || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
          if (!acc[section]) acc[section] = [];
          acc[section].push(cust);
          return acc;
        }, {});

        for (const sectionName in groupedCustomers) {
          const sectionRow = document.createElement("tr");
          sectionRow.innerHTML = `
<td colspan="7" style="background-color:#34495e;color:#fff">
ğŸ“ ${sectionName}
<input value="${sectionName}" data-oldname="${sectionName}" class="editSectionInput" />
<button class="saveSectionBtn" data-oldname="${sectionName}">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù…</button>
<button class="addCustomerToSectionBtn" data-section="${sectionName}">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
</td>`;
          tableBody.appendChild(sectionRow);

          groupedCustomers[sectionName].forEach((cust) => {
            const row = document.createElement("tr");
            row.innerHTML = `
<td>${cust.section}</td>
<td><input value="${cust.name}" data-id="${cust.id}" data-field="name"/></td>
<td><input value="${cust.phone}" data-id="${cust.id}" data-field="phone"/></td>
<td><input value="${cust.address || ""}" data-id="${
              cust.id
            }" data-field="address"/></td>
<td><input type="number" value="${cust.due_amount}" data-id="${
              cust.id
            }" data-field="due_amount"/></td>
<td>
  <select data-id="${cust.id}" data-field="collection_status">
    <option ${
      cust.collection_status === "ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„" ? "selected" : ""
    }>ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„</option>
    <option ${
      cust.collection_status !== "ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„" ? "selected" : ""
    }>Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„</option>
  </select>
</td>
<td>
  <button class="saveCustomerBtn" data-id="${cust.id}">ğŸ’¾ Ø­ÙØ¸</button>
  <button class="deleteCustomerBtn" data-id="${cust.id}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
</td>`;
            tableBody.appendChild(row);
          });
        }

        populateSectionFilter(customers);
      }

      function populateSectionFilter(customers) {
        const select = document.getElementById("sectionFilter");
        if (!select) return;

        const uniqueSections = new Set(
          customers.map((c) => c.section || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯")
        );
        select.innerHTML = '<option value="all">ğŸ“‚ Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>';
        uniqueSections.forEach((section) => {
          const option = document.createElement("option");
          option.value = section;
          option.textContent = section;
          select.appendChild(option);
        });
      }

      document
        .getElementById("searchInput")
        ?.addEventListener("keyup", applyFilters);
      document
        .getElementById("sectionFilter")
        ?.addEventListener("change", applyFilters);

      function applyFilters() {
        const filter = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const selectedSection = document.getElementById("sectionFilter").value;
        const rows = document.querySelectorAll("#adminCustomersTable tbody tr");

        let showSection = true;
        rows.forEach((row) => {
          const isSectionRow = row.querySelector("td")?.colSpan === 7;
          if (isSectionRow) {
            const sectionText = row.textContent.trim();
            showSection =
              selectedSection === "all" ||
              sectionText.includes(selectedSection);
            row.style.display = showSection ? "" : "none";
          } else {
            if (!showSection) {
              row.style.display = "none";
              return;
            }
            const name =
              row.cells[1]?.querySelector("input")?.value.toLowerCase() || "";
            const phone =
              row.cells[2]?.querySelector("input")?.value.toLowerCase() || "";
            row.style.display =
              name.includes(filter) || phone.includes(filter) ? "" : "none";
          }
        });
      }

      document
        .querySelector("#adminCustomersTable")
        ?.addEventListener("click", async (e) => {
          const id = e.target.getAttribute("data-id");

          if (e.target.classList.contains("saveCustomerBtn")) {
            const row = e.target.closest("tr");
            const inputs = row.querySelectorAll("[data-field]");

            const updatedData = {};
            inputs.forEach((input) => {
              const field = input.getAttribute("data-field");
              updatedData[field] = input.value.trim();
            });
            if (updatedData.due_amount) {
              updatedData.due_amount = Number(updatedData.due_amount);
            }

            const { error } = await supabase
              .from("customers")
              .update(updatedData)
              .eq("id", id);
            if (error) {
              alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª");
            } else {
              e.target.textContent = "âœ… ØªÙ…";
              setTimeout(() => (e.target.textContent = "ğŸ’¾ Ø­ÙØ¸"), 1500);
            }
          }

          if (e.target.classList.contains("deleteCustomerBtn")) {
            if (confirm("âš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ")) {
              const { error } = await supabase
                .from("customers")
                .delete()
                .eq("id", id);
              if (error) alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù");
              else e.target.closest("tr").remove();
            }
          }

          if (e.target.classList.contains("saveSectionBtn")) {
            const oldName = e.target.getAttribute("data-oldname");
            const input =
              e.target.parentElement.querySelector(".editSectionInput");
            const newName = input.value.trim();
            if (!newName || newName === oldName) return;

            const { error } = await supabase
              .from("customers")
              .update({ section: newName })
              .eq("section", oldName);
            if (error) alert("âŒ ÙØ´Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…");
            else {
              alert("âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­");
              loadCustomersForAdmin(
                document.getElementById("adminAgentSelect").value
              );
            }
          }

          if (e.target.classList.contains("addCustomerToSectionBtn")) {
            const section = e.target.getAttribute("data-section");
            const agent_id = document.getElementById("adminAgentSelect").value;
            if (!agent_id) return alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ø¯ÙˆØ¨");

            const name = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:");
            if (!name) return;

            const phone = prompt("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:");
            const address = prompt("Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:");
            const due_amount = prompt("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚:", "0");

            const { error } = await supabase.from("customers").insert({
              name,
              phone,
              address,
              due_amount: Number(due_amount),
              section,
              agent_id,
              collection_status: "Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„",
            });

            if (error) alert("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„");
            else {
              alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
              loadCustomersForAdmin(agent_id);
            }
          }
        });
      document
        .getElementById("clearButton")
        ?.addEventListener("click", async () => {
          if (confirm("âš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ØŸ")) {
            const { error } = await supabase
              .from("customers")
              .delete()
              .neq("id", 0);
            const status = document.getElementById("clearStatus");

            if (error) {
              status.textContent = "âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù";
              status.style.color = "red";
            } else {
              status.textContent = "âœ… ØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
              status.style.color = "lightgreen";
              document.querySelector("#adminCustomersTable tbody").innerHTML =
                "";
            }
          }
        });
    </script>
  </body>
</html>
