<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #2c3e50, #4ca1af);
        color: #333;
      }

      h1,
      h2 {
        text-align: center;
        color: #fff;
        margin-bottom: 20px;
      }
      select,
      input[type="file"] {
        padding: 10px;
        font-size: 14px;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-bottom: 10px;
        width: 250px;
        max-width: 90%;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      button {
        padding: 10px 20px;
        background: #27ae60;
        border: none;
        color: white;
        font-size: 14px;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.3s ease-in-out;
        margin-top: 10px;
      }

      button:hover {
        background: #219150;
      }

      #uploadStatus {
        background: #ecf0f1;
        color: #2c3e50;
        padding: 10px 15px;
        border-radius: 10px;
        font-weight: bold;
        max-width: 400px;
        margin: 10px auto;
        text-align: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      }

      .cards-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin-bottom: 40px;
      }

      .card {
        background-color: #ffffff;
        width: 200px;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        font-size: 16px;
      }

      .card div {
        font-size: 24px;
        font-weight: bold;
        margin-top: 10px;
        color: #2c3e50;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      }

      th,
      td {
        padding: 14px;
        text-align: center;
        border-bottom: 1px solid #eee;
      }

      th {
        background-color: #f8f9fa;
        color: #333;
      }

      a {
        color: #2980b9;
        text-decoration: none;
        font-weight: bold;
      }

      a:hover {
        text-decoration: underline;
      }
      /* âœ… ØªÙ†Ø³ÙŠÙ‚ Ù…Ø®ØµØµ Ù„Ù‚Ø³Ù… Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨ */
      #addAgentContainer h3 {
        font-size: 20px;
        font-weight: bold;
      }

      #addAgentContainer input,
      #addAgentContainer select {
        padding: 10px;
        font-size: 14px;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-bottom: 10px;
        width: 100%; /* Ù…Ù…Ù„ÙˆØ¡ Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†ØµØ± */
      }

      #addAgentContainer button {
        padding: 10px 20px;
        font-size: 14px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        background: #27ae60;
        color: #fff;
        transition: 0.3s ease-in-out;
      }

      #addAgentContainer button:hover {
        background: #219150;
      }

      @media (max-width: 768px) {
        .cards-container {
          flex-direction: column;
          align-items: center;
        }
        table,
        th,
        td {
          font-size: 13px;
        }
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  </head>

  <body>
    <header
      style="
        background: linear-gradient(45deg, #2c3e50, #4ca1af);
        padding: 15px 30px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        border-bottom-left-radius: 10px;
        border-bottom-right-radius: 10px;
      "
    >
      <div style="display: flex; align-items: center">
        <a href="./index.html">
          <img
            src="./Orange_logo.svg.png"
            alt="Logo"
            style="height: 50px; margin-left: 15px; border-radius: 8px"
          />
        </a>
        <h2 style="margin: 0">ÙÙˆÙƒØ³ Ø¨ÙŠØ²Ù†ÙŠØ³</h2>
      </div>
      <div style="font-size: 16px">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ­ØµÙŠÙ„</div>
    </header>

    <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</h1>

    <div class="cards-container">
      <div class="card">
        ğŸ“„ <br />Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
        <div id="total_invoices">0</div>
      </div>
      <div class="card">
        ğŸ’° <br />Ø§Ù„Ù…Ø­ØµÙ„ Ø§Ù„ÙŠÙˆÙ…
        <div id="total_collected">0</div>
      </div>
      <div class="card">
        ğŸ•’ <br />ÙÙˆØ§ØªÙŠØ± Ù…ØªØ£Ø®Ø±Ø©
        <div id="total_pending">0</div>
      </div>
      <div class="card">
        ğŸ“Š <br />Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²
        <div id="monthly_completion">0%</div>
      </div>

      <!-- ğŸ†• Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­ØµÙ„ Ø§Ù„ÙƒÙ„ÙŠ -->
      <div class="card">
        ğŸ’¸ <br />Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­ØµÙ„
        <div id="totalCollectedAll">0 Ø¬.Ù…</div>
      </div>

      <!-- ğŸ†• Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙƒÙ„ÙŠ -->
      <div class="card">
        ğŸ”„ <br />Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
        <div id="totalPendingAll">0 Ø¬.Ù…</div>
      </div>
    </div>

    <h2>Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ Ø§Ù„ÙŠÙˆÙ…</h2>
    <table>
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th>
          <th>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„ÙŠÙˆÙ…</th>
          <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„ Ø§Ù„ÙŠÙˆÙ…</th>
          <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙˆØ§ØªÙŠØ±Ù‡</th>
          <th>Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ØµÙ„Ø© Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± Ø§Ù„Ù…Ø¯Ø©</th>
          <th>Ø§Ù„Ù…Ø­ØµÙ„ Ø§Ù„ÙƒÙ„ÙŠ</th>
          <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</th>
          <th>Ø­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ…</th>
          <th>Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</th>
        </tr>
      </thead>
      <tbody id="agentsTable"></tbody>
    </table>
    <!-- âœ… HTML Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
    <h2>Ø±ÙØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
    <label for="agentSelect">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</label>
    <select
      id="agentSelect"
      style="margin: 10px 0; padding: 5px; border-radius: 5px"
    >
      <option value="">-- Ø§Ø®ØªØ± --</option>
    </select>
    <br />
    <input type="file" id="excelFile" />

    <button id="uploadButton">ğŸ“¤ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    <div id="uploadStatus" style="margin-top: 10px"></div>
    <div
      id="uploadLoader"
      style="display: none; text-align: center; margin-top: 10px"
    >
      <span
        style="
          padding: 10px 20px;
          background: #eee;
          border-radius: 8px;
          font-weight: bold;
          color: #333;
        "
      >
        â³ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
      </span>
    </div>

    <h2>Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
    <button id="clearButton">ğŸ§¨ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    <div id="clearStatus" style="font-weight: bold; margin: 10px 0"></div>
    <!-- âœ… ÙÙˆØ±Ù… Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨ Ø¹Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ -->
    <div id="addAgentContainer" style="max-width: 300px; margin: 20px auto">
      <h3>â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨</h3>
      <div
        id="addAgentAlert"
        style="display: none; padding: 10px; border-radius: 5px"
      ></div>
      <input
        id="newAgentName"
        placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨"
        style="width: 100%; margin-bottom: 10px"
      />
      <input
        id="newAgentEmail"
        placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
        style="width: 100%; margin-bottom: 10px"
      />
      <input
        id="newAgentPassword"
        placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
        style="width: 100%; margin-bottom: 10px"
      />
      <select id="newAgentRole" style="width: 100%; margin-bottom: 10px">
        <option value="agent">Ù…Ù†Ø¯ÙˆØ¨</option>
        <option value="admin">Ø£Ø¯Ù…Ù†</option>
      </select>
      <button id="addAgentButton">Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨</button>
    </div>

    <!-- Ø§Ù„ÙÙˆØªØ± -->
    <footer
      style="
        background: #2c3e50;
        color: #fff;
        text-align: center;
        padding: 15px;
        font-size: 14px;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        margin-top: 40px;
      "
    >
      <div>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; ÙÙˆÙƒØ³ Ø¨ÙŠØ²Ù†ÙŠØ³</div>
      <div>Ù…Ø·ÙˆØ± Ø§Ù„Ù†Ø¸Ø§Ù…: Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù‡Ø§Ù†ÙŠ</div>
      <div>Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: 01212555345</div>
    </footer>

    <!-- âœ… JavaScript Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ -->

    <script type="module">
      // âœ… 1. Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
      import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm";

      // âœ… 2. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase
      const supabase = createClient(
        "https://vyhtsdqccyvygelekzey.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5aHRzZHFjY3l2eWdlbGVremV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTQwOTMsImV4cCI6MjA2NTMzMDA5M30.bRjHD6OkziXjfavEX-tA-6IFdag7KoFBqLRgNLqwcdg"
      );

      // âœ… 3. ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù‡Ø§Ù… Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
      window.onload = async () => {
        await loadSummary();
        await loadAgents();
        await loadUploadAgents();

        // âœ… Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        document
          .getElementById("uploadButton")
          ?.addEventListener("click", uploadExcel);
        document
          .getElementById("deleteButton")
          ?.addEventListener("click", deleteCollectedLastMonth);
        document
          .getElementById("clearButton")
          ?.addEventListener("click", clearAllData);
      };

      // âœ… 4. ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù…Ù† Ø¬Ø¯ÙˆÙ„ daily_summary + Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„ÙƒÙ„ÙŠØ©
      async function loadSummary() {
        try {
          // ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
          const { data } = await supabase
            .from("daily_summary")
            .select("*")
            .limit(1)
            .maybeSingle();

          // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„ÙƒÙ„ÙŠ Ù…Ù† customers
          const { data: allCustomers } = await supabase
            .from("customers")
            .select("id");
          const totalInvoicesAllTime = allCustomers ? allCustomers.length : 0;

          // Ø¹Ø±Ø¶ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„ÙƒÙ„ÙŠ
          document.getElementById("total_invoices").innerText =
            totalInvoicesAllTime || 0;

          if (data) {
            document.getElementById("total_collected").innerText =
              data.total_collected || 0;
            document.getElementById("total_pending").innerText =
              data.total_pending_invoices || 0;

            // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
            let completionPercentage = 0;
            if (data.total_collected >= 7000) {
              completionPercentage = 90;
            } else if (data.total_collected >= 5000) {
              completionPercentage = 70;
            } else {
              completionPercentage = 30;
            }
            document.getElementById("monthly_completion").innerText =
              completionPercentage + "%";
          }

          // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­ØµÙ„ Ø§Ù„ÙƒÙ„ÙŠ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† Ø­Ø§Ù„ØªÙ‡Ù… "ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„"
          const { data: allCollected } = await supabase
            .from("customers")
            .select("due_amount")
            .eq("collection_status", "ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„");

          let totalCollectedAll = (allCollected || []).reduce(
            (sum, c) => sum + (c.due_amount || 0),
            0
          );

          // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙƒÙ„ÙŠ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† Ù„Ù… ÙŠØªÙ… ØªØ­ØµÙŠÙ„Ù‡Ù…
          const { data: allPending } = await supabase
            .from("customers")
            .select("due_amount")
            .neq("collection_status", "ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„");

          let totalPendingAll = (allPending || []).reduce(
            (sum, c) => sum + (c.due_amount || 0),
            0
          );

          // Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ… Ø¯Ø§Ø®Ù„ Ø¹Ù†Ø§ØµØ± HTML Ø¥Ø°Ø§ ÙƒØ§Ù†ÙˆØ§ Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†
          const totalCollectedAllEl =
            document.getElementById("totalCollectedAll");
          if (totalCollectedAllEl) {
            totalCollectedAllEl.innerText =
              totalCollectedAll.toFixed(2) + " Ø¬.Ù…";
          }

          const totalPendingAllEl = document.getElementById("totalPendingAll");
          if (totalPendingAllEl) {
            totalPendingAllEl.innerText = totalPendingAll.toFixed(2) + " Ø¬.Ù…";
          }
        } catch (err) {
          console.error("Error loading summary:", err);
        }
      }
      // âœ… 5. ØªØ­Ù…ÙŠÙ„ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ + Ø§Ù„Ù…Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„ÙØªØ±Ø©
      async function loadAgents() {
        try {
          const { data: agents } = await supabase
            .from("agents_summary")
            .select("*");
          const table = document.getElementById("agentsTable");
          table.innerHTML = ""; // ØªÙØ±ÙŠØº Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù‚Ø¨Ù„ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

          for (const agent of agents) {
            // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨
            const { data: agentCustomers } = await supabase
              .from("customers")
              .select("due_amount, collection_status")
              .eq("agent_id", agent.agent_id);

            let totalCollectedAll = 0;
            let totalPendingAll = 0;

            agentCustomers.forEach((c) => {
              if (c.collection_status === "ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„") {
                totalCollectedAll += c.due_amount || 0;
              } else {
                totalPendingAll += c.due_amount || 0;
              }
            });

            // âœ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„ÙØªØ±Ø©
            const agentInvoicesAllTime = agentCustomers
              ? agentCustomers.length
              : 0;

            // âœ… Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ØµÙ„Ø© Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„ÙØªØ±Ø©
            const agentCollectedInvoicesAllTime = agentCustomers.filter(
              (c) => c.collection_status === "ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„"
            ).length;

            const row = document.createElement("tr");
            row.innerHTML = `
        <td><a href="agent_customers.html?agent_id=${agent.agent_id}">${
              agent.agent_name
            }</a></td>
        <td>${agent.collected_invoices_today}</td>
        <td>${agent.collected_amount_today} Ø¬.Ù…</td>
        <td>${agentInvoicesAllTime} ÙØ§ØªÙˆØ±Ø©</td>
        <td>${agentCollectedInvoicesAllTime} ÙØ§ØªÙˆØ±Ø©</td>
        <td>${totalCollectedAll.toFixed(2)} Ø¬.Ù…</td>
        <td>${totalPendingAll.toFixed(2)} Ø¬.Ù…</td>
        <td>${agent.collected_invoices_today > 0 ? "âœ…" : "â³"}</td>
        <td>${
          agent.last_login
            ? new Date(agent.last_login).toLocaleString()
            : "Ù„Ù… ÙŠØ³Ø¬Ù„ Ø¨Ø¹Ø¯"
        }</td>
      `;
            table.appendChild(row);
          }
        } catch (err) {
          console.error("Error loading agents:", err);
        }
      }
      // âœ… 6. ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ Ù„Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      async function loadUploadAgents() {
        const { data } = await supabase.from("agents").select("id,name");
        const select = document.getElementById("agentSelect");
        data.forEach((agent) => {
          const opt = document.createElement("option");
          opt.value = agent.id;
          opt.textContent = agent.name;
          select.appendChild(opt);
        });
      }

      // âœ… 7. Ø±ÙØ¹ Ù…Ù„Ù Excel ÙˆØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      async function uploadExcel() {
        const fileInput = document.getElementById("excelFile");
        const status = document.getElementById("uploadStatus");
        const loader = document.getElementById("uploadLoader");
        const agent_id = document.getElementById("agentSelect").value;

        if (!agent_id) return setStatus("âš ï¸ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø£ÙˆÙ„Ø§Ù‹.", "red");
        if (!fileInput.files.length)
          return setStatus("ğŸ“„ Ø§Ø®ØªØ± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹.", "red");

        try {
          loader.style.display = "block";
          setStatus("", "");

          const file = fileInput.files[0];
          const data = new Uint8Array(await file.arrayBuffer());
          const workbook = XLSX.read(data, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet);

          if (!rows.length)
            return setStatus("âŒ Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ØºÙŠØ± ØµØ­ÙŠØ­.", "red");

          const currentMonth = new Date().toISOString().slice(0, 7);
          const newCustomers = [];
          const updates = [];

          for (const row of rows) {
            const phone = row.phone?.toString().trim();
            const due_amount = Number(row.due_amount) || 0;
            const name = row.name?.toString().trim() || null;
            const address = row.address?.toString().trim() || null;
            const section = row.section?.toString().trim() || null; // âœ… Ø¯Ø¹Ù… Ø§Ù„Ù‚Ø³Ù…

            if (!phone || due_amount <= 0) continue;

            // âœ… ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø³Ø¨Ù‚Ù‹Ø§
            const { data: existing, error: fetchError } = await supabase
              .from("customers")
              .select("*")
              .eq("phone", phone)
              .eq("agent_id", agent_id)
              .order("created_at", { ascending: false })
              .limit(1)
              .maybeSingle();

            if (fetchError) {
              console.warn("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„:", fetchError.message);
              continue;
            }

            if (existing) {
              if (existing.collection_status === "ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„") {
                newCustomers.push({
                  name,
                  phone,
                  address,
                  due_amount,
                  agent_id,
                  section,
                  billing_month: currentMonth,
                  collection_status: "Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„",
                });
              } else {
                updates.push({
                  id: existing.id,
                  due_amount: (existing.due_amount || 0) + due_amount,
                  billing_month: currentMonth,
                });
              }
            } else {
              newCustomers.push({
                name,
                phone,
                address,
                due_amount,
                agent_id,
                section,
                billing_month: currentMonth,
                collection_status: "Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„",
              });
            }
          }

          // âœ… Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù…Ù„Ø§Ø¡ Ø¬Ø¯Ø¯
          if (newCustomers.length > 0) {
            const { error: insertError } = await supabase
              .from("customers")
              .insert(newCustomers);
            if (insertError) {
              console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„:", insertError.message);
              return setStatus("âŒ ÙØ´Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.", "red");
            }
          }

          // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†
          for (const u of updates) {
            const { error: updateError } = await supabase
              .from("customers")
              .update({
                due_amount: u.due_amount,
                billing_month: u.billing_month,
              })
              .eq("id", u.id);
            if (updateError) {
              console.error(
                `âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„ ${u.id}:`,
                updateError.message
              );
            }
          }

          setStatus("âœ… ØªÙ… Ø±ÙØ¹ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.", "green");
          fileInput.value = "";
        } catch (err) {
          console.error("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£:", err.message);
          setStatus("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.", "red");
        } finally {
          loader.style.display = "none";
        }
      }

      // âœ… 9. Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      async function clearAllData() {
        const status = document.getElementById("clearStatus");
        if (!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) return;

        await supabase.from("collections").delete().not("id", "is", null);
        await supabase.from("customers").delete().not("id", "is", null);

        status.innerText = "âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.";
        status.style.color = "green";
      }

      // âœ… 10. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
      function setStatus(msg, color) {
        const el = document.getElementById("uploadStatus");
        el.innerText = msg;
        el.style.color = color;
      }

      // âœ… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨
      async function addAgent() {
        const name = document.getElementById("newAgentName").value.trim();
        const email = document.getElementById("newAgentEmail").value.trim();
        const password = document
          .getElementById("newAgentPassword")
          .value.trim();
        const role = document.getElementById("newAgentRole").value;

        const alertBox = document.getElementById("addAgentAlert");

        // âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„
        if (!name || !email || !password) {
          alertBox.innerText = "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.";
          alertBox.style.display = "block";
          alertBox.style.backgroundColor = "#f8d7da";
          alertBox.style.color = "#721c24";
          return;
        }

        try {
          // âœ… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„
          const { error } = await supabase
            .from("agents")
            .insert([{ name, email, password, role }]);

          if (error) {
            alertBox.innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨.";
            alertBox.style.display = "block";
            alertBox.style.backgroundColor = "#f8d7da";
            alertBox.style.color = "#721c24";
            console.error(error);
          } else {
            alertBox.innerText = "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…";
            alertBox.style.display = "block";
            alertBox.style.backgroundColor = "#d4edda"; // Ø£Ø®Ø¶Ø± ÙØ§ØªØ­
            alertBox.style.color = "#155724"; // Ø£Ø®Ø¶Ø± ØºØ§Ù…Ù‚

            // âœ… ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById("newAgentName").value = "";
            document.getElementById("newAgentEmail").value = "";
            document.getElementById("newAgentPassword").value = "";
          }
        } catch (err) {
          alertBox.innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.";
          alertBox.style.display = "block";
          alertBox.style.backgroundColor = "#f8d7da";
          alertBox.style.color = "#721c24";
          console.error(err);
        }
      }

      // âœ… Ø±Ø¨Ø· Ø§Ù„Ø²Ø± Ø¨Ø§Ù„Ø¯Ø§Ù„Ø©
      document
        .getElementById("addAgentButton")
        ?.addEventListener("click", addAgent);
    </script>
  </body>
</html>
