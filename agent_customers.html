<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>شيت عملاء المندوب</title>
    <style>
      /* =========================== General Styles =========================== */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #2c3e50, #4ca1af);
        color: #333;
      }
      h1,
      h3 {
        text-align: center;
        color: #fff;
      }
      /* =========================== Table Styles =========================== */
      table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 30px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      }
      th,
      td {
        padding: 14px;
        text-align: center;
        border-bottom: 1px solid #eee;
      }
      th {
        background-color: #f8f9fa;
        color: #333;
      }
      .status {
        font-weight: bold;
        padding: 8px 15px;
        border-radius: 20px;
        display: inline-block;
      }
      .paid {
        background-color: #2ecc71;
        color: #fff;
      }
      .unpaid {
        background-color: #e74c3c;
        color: #fff;
      }
      .section-header {
        background: #f1f1f1;
        font-weight: bold;
        text-align: right;
        font-size: 16px;
        padding: 12px 20px;
        color: #2c3e50;
        border-radius: 8px;
        margin: 30px 0 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      #searchBarContainer {
        position: sticky;
        top: 0;
        z-index: 1000;
        background-color: #fff;
        padding: 10px;
        display: flex;
        justify-content: center;
        gap: 10px;
        align-items: center;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        margin-bottom: 20px;
      }
      #searchInput {
        padding: 10px;
        flex: 1;
        max-width: 300px;
        border-radius: 8px;
        border: 1px solid #ccc;
      }
      #searchButton {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: bold;
        background: #27ae60;
        color: #fff;
        border: none;
        cursor: pointer;
      }
      #searchButton:hover {
        background: #1e8449;
      }
      #scrollToTopBtn {
        position: fixed;
        bottom: 30px;
        left: 30px;
        font-size: 24px;
        padding: 12px 15px;
        border-radius: 50%;
        border: none;
        background-color: #3498db;
        color: #fff;
        cursor: pointer;
        display: none;
        z-index: 1001;
      }
      /* Responsive */
      @media (max-width: 768px) {
        table,
        th,
        td {
          font-size: 13px;
        }
        .section-header {
          font-size: 15px;
          padding: 10px;
        }
      }
    </style>
  </head>
  <body>
    <!-- ✅ الهيدر -->
    <header
      style="
        background: linear-gradient(45deg, #2c3e50, #4ca1af);
        padding: 15px 30px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        border-bottom-left-radius: 10px;
        border-bottom-right-radius: 10px;
      "
    >
      <div style="display: flex; align-items: center">
        <a href="./dashboard.html">
          <img
            src="./Orange_logo.svg.png"
            alt="Logo"
            style="height: 50px; margin-left: 15px; border-radius: 8px"
          />
        </a>
        <h2 style="margin: 0">فوكس بيزنيس</h2>
      </div>
      <div style="font-size: 16px">نظام إدارة التحصيل</div>
    </header>

    <!-- ✅ العنوان -->
    <h1 id="agentName">جاري التحميل...</h1>
    <h3 id="totalDue">جاري حساب الإجمالي...</h3>

    <!-- ✅ البحث -->
    <div id="searchBarContainer">
      <input
        type="text"
        id="searchInput"
        placeholder="اكتب الاسم أو الرقم للبحث..."
      />
      <button id="searchButton">🔍 بحث</button>
    </div>

    <!-- ✅ الجدول + العملاء -->
    <div id="customersSections"></div>

    <!-- ✅ السهم للرجوع لأعلى -->
    <button id="scrollToTopBtn">⬆️</button>

    <!-- ✅ الفوتر -->
    <footer
      style="
        background: #2c3e50;
        color: #fff;
        text-align: center;
        padding: 15px;
        font-size: 14px;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        margin-top: 40px;
      "
    >
      <div>جميع الحقوق محفوظة &copy; فوكس بيزنيس</div>
      <div>مطور النظام: عبدالله هاني</div>
      <div>خدمة العملاء: 01212555345</div>
    </footer>

    <!-- ✅ السكربت -->
    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const supabase = createClient(
        "https://vyhtsdqccyvygelekzey.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5aHRzZHFjY3l2eWdlbGVremV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTQwOTMsImV4cCI6MjA2NTMzMDA5M30.bRjHD6OkziXjfavEX-tA-6IFdag7KoFBqLRgNLqwcdg"
      );

      let customersData = []; // تعريف على المستوى العام
      let notesData = []; // تعريف على المستوى العام

      window.onload = async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const agent_id = urlParams.get("agent_id");
        if (!agent_id) {
          alert("لم يتم تحديد المندوب");
          return;
        }
        await loadAgentInfo(agent_id);
        await loadCustomers(agent_id);
      };

      async function loadAgentInfo(agent_id) {
        const { data, error } = await supabase
          .from("agents")
          .select("name")
          .eq("id", agent_id)
          .single();
        if (error || !data) {
          alert("تعذر تحميل بيانات المندوب");
          return;
        }
        document.getElementById("agentName").innerText =
          "شيت العملاء: " + data.name;
      }

      async function loadCustomers(agent_id) {
        try {
          const { data: customers, error: customerError } = await supabase
            .from("customers")
            .select("*")
            .eq("agent_id", agent_id)
            .order("section", { ascending: true })
            .order("created_at", { ascending: true });
          const { data: notes, error: notesError } = await supabase
            .from("agent_notes")
            .select("customer_phone, note_text")
            .eq("agent_id", agent_id);

          if (customerError || notesError) {
            throw customerError || notesError;
          }

          customersData = customers;
          notesData = notes;

          displayCustomers(customersData, notesData);
        } catch (err) {
          console.error("❌ خطأ:", err);
          alert("❌ حدث خطأ أثناء تحميل العملاء أو الملاحظات");
        }
      }

      function displayCustomers(data, notes) {
        const container = document.getElementById("customersSections");
        container.innerHTML = ""; // تفريغ قبل العرض
        let totalDueAmount = 0;
        let lastSection = null;

        for (const customer of data) {
          if (customer.collection_status !== "تم التحصيل") {
            totalDueAmount += customer.due_amount || 0;
          }

          if (customer.section !== lastSection) {
            lastSection = customer.section;

            const sectionHeader = document.createElement("div");
            sectionHeader.className = "section-header";
            sectionHeader.textContent =
              "📌 القسم: " + (lastSection || "غير محدد");
            container.appendChild(sectionHeader);

            var table = document.createElement("table");
            table.innerHTML = `
        <thead>
          <tr>
            <th>اسم العميل</th>
            <th>رقم الهاتف</th>
            <th>قيمة الفاتورة</th>
            <th>حالة التحصيل</th>
            <th>ملاحظة المندوب</th>
          </tr>
        </thead>`;
            var tbody = document.createElement("tbody");
            table.appendChild(tbody);
            container.appendChild(table);
          }

          const statusClass =
            customer.collection_status === "تم التحصيل" ? "paid" : "unpaid";
          const note =
            notes.find((n) => n.customer_phone === customer.phone)?.note_text ||
            "";

          const row = document.createElement("tr");
          row.innerHTML = `
      <td>${customer.name}</td>
      <td>${customer.phone}</td>
      <td>${customer.due_amount} ج.م</td>
      <td><span class="status ${statusClass}">${customer.collection_status}</span></td>
      <td>${note}</td>`;
          table.querySelector("tbody").appendChild(row);
        }

        document.getElementById(
          "totalDue"
        ).innerText = `إجمالي المبالغ المتبقية: ${totalDueAmount.toFixed(
          2
        )} ج.م`;
      }

      // ✅ البحث
      document.getElementById("searchButton").addEventListener("click", () => {
        const query = document.getElementById("searchInput").value.trim();
        if (!query) {
          alert("⚠️ أدخل الاسم أو الرقم للبحث");
          return;
        }
        const filteredCustomers = customersData.filter(
          (c) => c.name.includes(query) || c.phone.includes(query)
        );
        if (!filteredCustomers.length) {
          alert("❌ لم يتم العثور على عملاء");
          return;
        }
        displayCustomers(filteredCustomers, notesData);
      });

      // ✅ السهم للرجوع لأعلى
      const scrollToTopBtn = document.getElementById("scrollToTopBtn");
      window.addEventListener("scroll", () => {
        scrollToTopBtn.style.display = window.scrollY > 300 ? "block" : "none";
      });
      scrollToTopBtn.addEventListener("click", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    </script>
  </body>
</html>
