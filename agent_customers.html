<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>Ø´ÙŠØª Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</title>

    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #2c3e50, #4ca1af);
        color: #333;
      }

      h1 {
        text-align: center;
        color: #fff;
        margin-bottom: 10px;
      }

      h3 {
        text-align: center;
        color: #fff;
        margin-bottom: 30px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        margin-bottom: 30px;
      }

      th,
      td {
        padding: 14px;
        text-align: center;
        border-bottom: 1px solid #eee;
      }

      th {
        background-color: #f8f9fa;
        color: #333;
      }

      .status {
        font-weight: bold;
        padding: 8px 15px;
        border-radius: 20px;
        display: inline-block;
      }

      .paid {
        background-color: #2ecc71;
        color: #fff;
      }

      .unpaid {
        background-color: #e74c3c;
        color: #fff;
      }

      .section-header {
        background: #f1f1f1;
        font-weight: bold;
        text-align: right;
        font-size: 16px;
        padding: 12px 20px;
        color: #2c3e50;
        border-radius: 8px;
        margin: 30px 0 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      @media (max-width: 768px) {
        table,
        th,
        td {
          font-size: 13px;
        }
        .section-header {
          font-size: 15px;
          padding: 10px;
        }
      }
    </style>
  </head>

  <body>
    <!-- âœ… Ø§Ù„Ù‡ÙŠØ¯Ø± -->
    <header
      style="
        background: linear-gradient(45deg, #2c3e50, #4ca1af);
        padding: 15px 30px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        border-bottom-left-radius: 10px;
        border-bottom-right-radius: 10px;
      "
    >
      <div style="display: flex; align-items: center">
        <a href="./dashboard.html">
          <img
            src="./Orange_logo.svg.png"
            alt="Logo"
            style="height: 50px; margin-left: 15px; border-radius: 8px"
          />
        </a>
        <h2 style="margin: 0">ÙÙˆÙƒØ³ Ø¨ÙŠØ²Ù†ÙŠØ³</h2>
      </div>
      <div style="font-size: 16px">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ­ØµÙŠÙ„</div>
    </header>

    <!-- âœ… Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
    <h1 id="agentName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h1>
    <h3 id="totalDue">Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ...</h3>
    <input
      type="text"
      id="searchPhone"
      placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"
      style="
        padding: 10px;
        width: 250px;
        margin-bottom: 15px;
        border-radius: 8px;
      "
    />
    <button onclick="searchCustomer()">ğŸ” Ø¨Ø­Ø«</button>

    <!-- âœ… Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
    <div id="customersSections"></div>

    <!-- âœ… Ø§Ù„ÙÙˆØªØ± -->
    <footer
      style="
        background: #2c3e50;
        color: #fff;
        text-align: center;
        padding: 15px;
        font-size: 14px;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        margin-top: 40px;
      "
    >
      <div>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; ÙÙˆÙƒØ³ Ø¨ÙŠØ²Ù†ÙŠØ³</div>
      <div>Ù…Ø·ÙˆØ± Ø§Ù„Ù†Ø¸Ø§Ù…: Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù‡Ø§Ù†ÙŠ</div>
      <div>Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: 01212555345</div>
    </footer>
    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const supabase = createClient(
        "https://vyhtsdqccyvygelekzey.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5aHRzZHFjY3l2eWdlbGVremV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTQwOTMsImV4cCI6MjA2NTMzMDA5M30.bRjHD6OkziXjfavEX-tA-6IFdag7KoFBqLRgNLqwcdg"
      );

      window.onload = async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const agent_id = urlParams.get("agent_id");

        if (!agent_id) {
          alert("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨");
          return;
        }

        await loadAgentInfo(agent_id);
        await loadCustomers(agent_id);
      };

      async function loadAgentInfo(agent_id) {
        const { data, error } = await supabase
          .from("agents")
          .select("name")
          .eq("id", agent_id)
          .single();

        if (error || !data) {
          alert("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨");
          return;
        }

        document.getElementById("agentName").innerText =
          "Ø´ÙŠØª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: " + data.name;
      }

      async function loadCustomers(agent_id) {
        try {
          const { data: customers, error: customerError } = await supabase
            .from("customers")
            .select("*")
            .eq("agent_id", agent_id)
            .order("section", { ascending: true })
            .order("created_at", { ascending: true });

          const { data: notes, error: notesError } = await supabase
            .from("agent_notes")
            .select("customer_phone, note_text")
            .eq("agent_id", agent_id);

          if (customerError || notesError) throw customerError || notesError;

          const container = document.getElementById("customersSections");
          let totalDueAmount = 0;
          let lastSection = null;
          let table = null;
          let tbody = null;

          for (const customer of customers) {
            if (customer.collection_status !== "ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„") {
              totalDueAmount += customer.due_amount || 0;
            }

            if (customer.section !== lastSection) {
              lastSection = customer.section;

              const sectionHeader = document.createElement("div");
              sectionHeader.className = "section-header";
              sectionHeader.textContent =
                "ğŸ“Œ Ø§Ù„Ù‚Ø³Ù…: " + (lastSection || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯");
              container.appendChild(sectionHeader);

              table = document.createElement("table");
              table.innerHTML = `
            <thead>
              <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th>Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                <th>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­ØµÙŠÙ„</th>
                <th>Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th>
              </tr>
            </thead>
          `;
              tbody = document.createElement("tbody");
              table.appendChild(tbody);
              container.appendChild(table);
            }

            const statusClass =
              customer.collection_status === "ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„" ? "paid" : "unpaid";

            const note =
              notes.find((n) => n.customer_phone === customer.phone)
                ?.note_text || "";

            const row = document.createElement("tr");
            row.innerHTML = `
          <td>${customer.name}</td>
          <td>${customer.phone}</td>
          <td>${customer.due_amount} Ø¬.Ù…</td>
          <td><span class="status ${statusClass}">${customer.collection_status}</span></td>
          <td>${note}</td>
        `;
            tbody.appendChild(row);
          }

          document.getElementById(
            "totalDue"
          ).innerText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${totalDueAmount.toFixed(
            2
          )} Ø¬.Ù…`;
        } catch (err) {
          console.error("âŒ Error:", err);
          alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª");
        }
      }
      window.searchCustomer = function () {
        const phone = document.getElementById("searchPhone").value.trim();
        if (!phone) return alert("âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ø¨Ø­Ø«");

        // Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
        const rows = document.querySelectorAll("tr");
        let found = false;

        rows.forEach((row) => {
          if (row.innerText.includes(phone)) {
            row.scrollIntoView({ behavior: "smooth", block: "center" });
            row.style.backgroundColor = "#ffffcc"; // ØªÙ…ÙŠÙŠØ² Ø§Ù„ØµÙ
            found = true;

            // Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
            setTimeout(() => {
              row.style.backgroundColor = "";
            }, 3000);
          }
        });

        if (!found) alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„");
      };
    </script>
  </body>
</html>
