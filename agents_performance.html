<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</title>
    <!-- Ù…ÙƒØªØ¨Ø© Supabase + XLSX -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
      /* =========== Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© =========== */
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #2c3e50, #4ca1af);
        color: #333;
      }

      h1,
      h2 {
        text-align: center;
        color: #fff;
        margin-bottom: 20px;
      }

      /* =========== Ø§Ù„Ø¬Ø¯ÙˆÙ„ =========== */
      table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 12px;
        overflow: hidden;
        background: #fff;
        box-shadow: 0px 8px 20px rgba(0, 0, 0, 0.2);
      }

      th,
      td {
        padding: 14px;
        text-align: center;
        border-bottom: 1px solid #eee;
      }

      th {
        background-color: #f8f9fa;
        color: #333;
        font-weight: bold;
      }

      /* =========== Ø§Ù„Ù„ÙŠÙ†ÙƒØ§Øª =========== */
      a {
        color: orange;
        text-decoration: none;
        font-weight: bold;
        transition: color 0.3s, text-decoration 0.3s;
      }

      a:hover {
        color: #ff9800;
        text-decoration: underline;
      }
      #openSendMessageModal {
        padding: 12px 24px;
        font-size: 16px;
        font-weight: bold;
        color: #fff;
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0px 4px 12px rgba(46, 204, 113, 0.3);
        margin: 20px auto;
        display: block;
      }

      #openSendMessageModal:hover {
        background: linear-gradient(135deg, #219150, #27ae60);
        transform: translateY(-3px);
        box-shadow: 0px 6px 18px rgba(46, 204, 113, 0.4);
      }

      #openSendMessageModal:active {
        transform: translateY(1px);
        box-shadow: 0px 3px 10px rgba(46, 204, 113, 0.25);
      }
      /* =========== Ø§Ù„ÙÙˆØªØ± =========== */
      footer {
        background: #2c3e50;
        color: #fff;
        text-align: center;
        padding: 15px;
        font-size: 14px;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        margin-top: 40px;
      }

      /* =========== Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ØµØºÙŠØ±Ø© =========== */
      @media (max-width: 768px) {
        table {
          display: block;
          width: 100%;
          overflow-x: auto;
        }
      }
    </style>
  </head>
  <body>
    <header
      style="
        background: linear-gradient(45deg, #2c3e50, #4ca1af);
        padding: 15px 30px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: #fff;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
        border-bottom-left-radius: 10px;
        border-bottom-right-radius: 10px;
      "
    >
      <div style="display: flex; align-items: center">
        <a href="./index.html"
          ><img
            src="./Orange_logo.svg.png"
            alt="Logo"
            style="height: 50px; margin-left: 15px; border-radius: 8px"
        /></a>
        <h2 style="margin: 0">ÙÙˆÙƒØ³ Ø¨ÙŠØ²Ù†ÙŠØ³</h2>
      </div>
      <div style="font-size: 16px; display: flex; gap: 20px">
        <a href="./management.html"><h2>Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ â¬…</h2></a>
        <a href="./agents_performance.html"><h2>Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ â¬…</h2></a>
        <a href="./dashboard.html"><h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â¬…</h2></a>
      </div>
    </header>

    <h1>Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ Ø§Ù„ÙŠÙˆÙ…</h1>
    <table>
      <thead>
        <tr>
          <th>Ø´ÙŠØª Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th>
          <th>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„ÙŠÙˆÙ…</th>
          <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„ Ø§Ù„ÙŠÙˆÙ…</th>
          <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙˆØ§ØªÙŠØ±Ù‡</th>
          <th>Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ØµÙ„Ø© Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± Ø§Ù„Ù…Ø¯Ø©</th>
          <th>Ø§Ù„Ù…Ø­ØµÙ„ Ø§Ù„ÙƒÙ„ÙŠ</th>
          <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</th>
          <th>Ø­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ…</th>
          <th>Ø£ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</th>
          <th>Ù…ÙˆÙ‚Ø¹ Ø£ÙˆÙ„ Ø¯Ø®ÙˆÙ„</th>

          <th>Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</th>
          <th>ØªØªØ¨Ø¹ Ù…Ø¨Ø§Ø´Ø±</th>
        </tr>
      </thead>
      <tbody id="agentsTable"></tbody>
    </table>

    <!-- Button Ù„ÙØªØ­ Ø§Ù„Ø¨ÙˆØ¨-Ø£Ø¨ -->
    <button id="openSendMessageModal">âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©</button>

    <!-- Ø§Ù„Ø¨ÙˆØ¨-Ø£Ø¨ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ -->
    <div
      id="sendAgentMessageModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      "
    >
      <div
        style="
          background: #fff;
          padding: 20px;
          border-radius: 12px;
          max-width: 400px;
          width: 100%;
          font-family: Arial, sans-serif;
        "
      >
        <h3>âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨</h3>
        <label for="sendAgentSelect">ğŸ‘¤ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</label>
        <select id="sendAgentSelect"></select>
        <input id="sendTitle" type="text" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" />
        <textarea id="sendBody" placeholder="Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©"></textarea>
        <div
          id="sendAlertBox"
          style="
            display: none;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
          "
        ></div>
        <div style="text-align: left">
          <button id="sendAgentButton">ğŸ“© Ø¥Ø±Ø³Ø§Ù„</button>
          <button id="closeSendAgentModal" style="background: #c0392b">
            âŒ Ø¥ØºÙ„Ø§Ù‚
          </button>
        </div>
      </div>
    </div>
    <footer>
      <div>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; ÙÙˆÙƒØ³ Ø¨ÙŠØ²Ù†ÙŠØ³</div>
      <div>Ù…Ø·ÙˆØ± Ø§Ù„Ù†Ø¸Ø§Ù…: Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù‡Ø§Ù†ÙŠ</div>
      <div>Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: 01212555345</div>
    </footer>

    <!-- JavaScript -->
    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const supabase = createClient(
        "https://vyhtsdqccyvygelekzey.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5aHRzZHFjY3l2eWdlbGVremV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTQwOTMsImV4cCI6MjA2NTMzMDA5M30.bRjHD6OkziXjfavEX-tA-6IFdag7KoFBqLRgNLqwcdg"
      );

      window.onload = async () => {
        await loadAgentsData();
        attachEventListeners();
      };

      function attachEventListeners() {
        document
          .getElementById("openSendMessageModal")
          .addEventListener("click", async () => {
            await loadAgentsForMessage();
            document.getElementById("sendAgentMessageModal").style.display =
              "flex";
          });
        document
          .getElementById("closeSendAgentModal")
          .addEventListener("click", () => {
            document.getElementById("sendAgentMessageModal").style.display =
              "none";
          });
        document
          .getElementById("sendAgentButton")
          .addEventListener("click", sendAgentMessage);
      }

      // âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      async function loadAgentsData() {
        try {
          const { data: agents } = await supabase.from("agents").select("*");
          const table = document.getElementById("agentsTable");
          table.innerHTML = "";

          // âœ… ØªÙˆÙ‚ÙŠØª Ø§Ù„ÙŠÙˆÙ… Ù…Ù† 6 ØµØ¨Ø§Ø­Ù‹Ø§ Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©
          const now = new Date();
          const utc = now.getTime() + now.getTimezoneOffset() * 60000;
          const cairoOffsetMs = 3 * 60 * 60 * 1000;
          const nowCairo = new Date(utc + cairoOffsetMs);
          let start = new Date(nowCairo);
          start.setHours(6, 0, 0, 0);
          if (nowCairo.getHours() < 6) {
            start.setDate(start.getDate() - 1);
          }
          const end = new Date(start.getTime() + 24 * 60 * 60 * 1000);
          const todayStart = start.toISOString();
          const todayEnd = end.toISOString();

          for (const agent of agents) {
            const { data: agentCustomers } = await supabase
              .from("customers")
              .select("due_amount, collection_status")
              .eq("agent_id", agent.id);

            let totalCollectedAll = 0,
              totalPendingAll = 0;

            agentCustomers?.forEach((c) => {
              if (c.collection_status === "ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„") {
                totalCollectedAll += c.due_amount || 0;
              } else {
                totalPendingAll += c.due_amount || 0;
              }
            });

            const agentInvoicesAllTime = agentCustomers?.length || 0;
            const agentCollectedInvoicesAllTime = agentCustomers.filter(
              (c) => c.collection_status === "ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„"
            ).length;

            const { data: agentCollectionsToday } = await supabase
              .from("collections")
              .select("amount, collection_date")
              .eq("collected_by", agent.id)
              .gte("collection_date", todayStart)
              .lt("collection_date", todayEnd);

            const collectedTodayCount = agentCollectionsToday?.length || 0;
            const collectedTodayAmount = agentCollectionsToday?.reduce(
              (sum, item) => sum + (item.amount || 0),
              0
            );

            // âœ… Ø¬Ù„Ø¨ Ø£ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
            const { data: firstLoc } = await supabase
              .from("agent_locations")
              .select("*")
              .eq("agent_id", agent.id)
              .gte("timestamp", todayStart)
              .lte("timestamp", todayEnd)
              .order("timestamp", { ascending: true })
              .limit(1);

            // âœ… Ø¬Ù„Ø¨ Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
            const { data: lastLoc } = await supabase
              .from("agent_locations")
              .select("*")
              .eq("agent_id", agent.id)
              .gte("timestamp", todayStart)
              .lte("timestamp", todayEnd)
              .order("timestamp", { ascending: false })
              .limit(1);

            const firstLocation = firstLoc?.[0];
            const lastLocation = lastLoc?.[0];

            let firstLoginTime = "â³";
            let firstLocationDisplay = "â³";
            let lastLoginTime = "â³";
            let lastLocationDisplay = "â³";

            if (firstLocation) {
              firstLoginTime = `ğŸ•’ ${new Date(
                firstLocation.timestamp
              ).toLocaleString("ar-EG")}`;
              if (firstLocation.latitude && firstLocation.longitude) {
                const lat = firstLocation.latitude;
                const lng = firstLocation.longitude;
                firstLocationDisplay = `<a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" style="color:blue;text-decoration:underline">ğŸ“ Ø®Ø±ÙŠØ·Ø©</a>`;
              }
            }

            if (lastLocation) {
              lastLoginTime = `ğŸ‘‹ ${new Date(
                lastLocation.timestamp
              ).toLocaleString("ar-EG")}`;
              if (lastLocation.latitude && lastLocation.longitude) {
                const lat = lastLocation.latitude;
                const lng = lastLocation.longitude;
                lastLocationDisplay =
                  window.innerWidth <= 768
                    ? `<a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" style="color:blue;text-decoration:underline">ğŸ“ Ø¹Ø±Ø¶</a>`
                    : `<iframe src="https://www.google.com/maps?q=${lat},${lng}&output=embed" style="border:0;width:100%;height:150px;" allowfullscreen loading="lazy"></iframe>`;
              }
            }

            const columns = [
              `<a href="agent_customers.html?agent_id=${agent.id}">${agent.name}</a>`,
              collectedTodayCount,
              `${collectedTodayAmount.toFixed(2)} Ø¬.Ù…`,
              `${agentInvoicesAllTime} ÙØ§ØªÙˆØ±Ø©`,
              `${agentCollectedInvoicesAllTime} ÙØ§ØªÙˆØ±Ø©`,
              `${totalCollectedAll.toFixed(2)} Ø¬.Ù…`,
              `${totalPendingAll.toFixed(2)} Ø¬.Ù…`,
              collectedTodayCount > 0 ? "âœ…" : "â³",
              firstLoginTime,
              firstLocationDisplay,
              lastLoginTime,
              lastLocationDisplay,
            ];

            const labels = [
              "Ø´ÙŠØª Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨",
              "Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„ÙŠÙˆÙ…",
              "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„ Ø§Ù„ÙŠÙˆÙ…",
              "Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙˆØ§ØªÙŠØ±Ù‡",
              "Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ØµÙ„Ø© Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± Ø§Ù„Ù…Ø¯Ø©",
              "Ø§Ù„Ù…Ø­ØµÙ„ Ø§Ù„ÙƒÙ„ÙŠ",
              "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙƒÙ„ÙŠ",
              "Ø­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ…",
              "Ø£ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„",
              "Ù…ÙˆÙ‚Ø¹ Ø£ÙˆÙ„ Ø¯Ø®ÙˆÙ„",
              "Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„",
              "ØªØªØ¨Ø¹ Ù…Ø¨Ø§Ø´Ø±",
            ];

            const row = document.createElement("tr");
            columns.forEach((content, index) => {
              const td = document.createElement("td");
              td.setAttribute("data-label", labels[index]);
              td.innerHTML = content;
              row.appendChild(td);
            });
            table.appendChild(row);
          }
        } catch (error) {
          console.error(error);
          alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„");
        }
      }
      async function sendAgentMessage() {
        const title = document.getElementById("sendTitle").value.trim();
        const body = document.getElementById("sendBody").value.trim();
        const agent_id = document.getElementById("sendAgentSelect").value;

        const alertBox = document.getElementById("sendAlertBox");

        if (!title || !body || !agent_id) {
          alertBox.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„.";
          alertBox.style.display = "block";
          alertBox.style.background = "#f8d7da";
          alertBox.style.color = "#721c24";
          return;
        }

        const { error } = await supabase
          .from("messages")
          .insert([{ title, body, agent_id }]);

        if (error) {
          alertBox.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.";
          alertBox.style.display = "block";
          alertBox.style.background = "#f8d7da";
          alertBox.style.color = "#721c24";
          console.error(error);
        } else {
          alertBox.textContent = "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­.";
          alertBox.style.display = "block";
          alertBox.style.background = "#d4edda";
          alertBox.style.color = "#155724";
          document.getElementById("sendTitle").value = "";
          document.getElementById("sendBody").value = "";
          setTimeout(() => {
            document.getElementById("sendAgentMessageModal").style.display =
              "none";
          }, 1500);
        }
      }

      async function loadAgentsForMessage() {
        const select = document.getElementById("sendAgentSelect");
        select.innerHTML = "";
        const { data: agents } = await supabase.from("agents").select("*");
        agents?.forEach((agent) => {
          const option = document.createElement("option");
          option.value = agent.id;
          option.textContent = agent.name;
          select.appendChild(option);
        });
      }
    </script>
  </body>
</html>
